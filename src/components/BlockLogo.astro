---
/**
 * ZERO Block Letter Logo — Claude Code / Pixel Brick style
 * V1: Sharp brutalist — no radius, hard shadows, phosphor green
 * Animation: CRT power-on — horizontal line expands vertically, blocks materialize
 * V2: Living logo — breathing, agent status, hover scatter, metric flash
 */

const letters: Record<string, number[][]> = {
  Z: [
    [1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1],
    [0,0,0,0,0,0,1,1],
    [0,0,0,0,0,1,1,0],
    [0,0,0,0,1,1,0,0],
    [0,0,0,1,1,0,0,0],
    [0,0,1,1,0,0,0,0],
    [0,1,1,0,0,0,0,0],
    [1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1],
  ],
  E: [
    [1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1],
    [1,1,0,0,0,0,0,0],
    [1,1,0,0,0,0,0,0],
    [1,1,1,1,1,1,1,0],
    [1,1,1,1,1,1,1,0],
    [1,1,0,0,0,0,0,0],
    [1,1,0,0,0,0,0,0],
    [1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,1],
  ],
  R: [
    [1,1,1,1,1,1,1,0],
    [1,1,1,1,1,1,1,1],
    [1,1,0,0,0,0,1,1],
    [1,1,0,0,0,0,1,1],
    [1,1,1,1,1,1,1,1],
    [1,1,1,1,1,1,1,0],
    [1,1,0,0,1,1,0,0],
    [1,1,0,0,0,1,1,0],
    [1,1,0,0,0,0,1,1],
    [1,1,0,0,0,0,1,1],
  ],
  O: [
    [0,1,1,1,1,1,1,0],
    [1,1,1,1,1,1,1,1],
    [1,1,0,0,0,0,1,1],
    [1,1,0,0,0,0,1,1],
    [1,1,0,0,0,0,1,1],
    [1,1,0,0,0,0,1,1],
    [1,1,0,0,0,0,1,1],
    [1,1,0,0,0,0,1,1],
    [1,1,1,1,1,1,1,1],
    [0,1,1,1,1,1,1,0],
  ],
};

const word = "ZERO";
const COLS = 8;
const ROWS = 10;

type CellInfo = { on: boolean; row: number; col: number };
const letterCells: CellInfo[][] = [];

for (const ch of word) {
  const grid = letters[ch];
  if (!grid) continue;
  const cells: CellInfo[] = [];
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      cells.push({ on: grid[r][c] === 1, row: r, col: c });
    }
  }
  letterCells.push(cells);
}

// Agent mapping: Z=SERAPHIM, E=CHRONICLE+AESTHETE, R=SQUAER, O=SENTINEL
const letterAgents = ['seraphim', 'chronicle,aesthete', 'squaer', 'sentinel'];
---

<div class="block-logo crt-boot" role="img" aria-label="ZERO">
  {letterCells.map((cells, li) => (
    <div class="block-letter" data-letter-index={li} data-agents={letterAgents[li]}>
      {cells.map((cell) => (
        <div
          class:list={['block-cell', cell.on ? 'on' : 'off']}
          data-row={cell.row}
        />
      ))}
    </div>
  ))}
  <div class="crt-scanline"></div>
</div>

<style>
  .block-logo {
    display: flex;
    gap: 6px;
    align-items: center;
    padding: 4px 0;
    position: relative;
    overflow: hidden;
  }

  .block-letter {
    display: grid;
    grid-template-columns: repeat(8, var(--block-size, 9px));
    gap: var(--block-gap, 1.5px);
  }

  .block-cell {
    width: var(--block-size, 9px);
    height: var(--block-size, 9px);
  }

  .block-cell.off {
    background: transparent;
  }

  /* ── CRT POWER-ON ANIMATION ── */

  .crt-boot {
    animation: crtExpand 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.3s both;
  }

  @keyframes crtExpand {
    0% {
      transform: scaleY(0.02);
      filter: brightness(3) blur(2px);
    }
    15% {
      transform: scaleY(0.02);
      filter: brightness(4) blur(3px);
    }
    40% {
      transform: scaleY(0.6);
      filter: brightness(2) blur(1px);
    }
    60% {
      transform: scaleY(1.05);
      filter: brightness(1.5) blur(0px);
    }
    80% {
      transform: scaleY(0.98);
      filter: brightness(1.1);
    }
    100% {
      transform: scaleY(1);
      filter: brightness(1) blur(0px);
    }
  }

  /* Phase 2: Blocks materialize after expand */
  .block-cell.on {
    background: var(--phosphor);
    border: 1px solid rgba(0,0,0,0.3);
    box-shadow: inset -1.5px -1.5px 0 rgba(0,0,0,0.2), inset 1.5px 1.5px 0 rgba(255,255,255,0.08);
    animation: blockMaterialize 0.4s ease-out both;
    animation-delay: calc(0.6s + var(--row-delay, 0ms));
  }

  /* Row delays — center-out pattern */
  .block-cell.on[data-row="4"],
  .block-cell.on[data-row="5"] { --row-delay: 0ms; }
  .block-cell.on[data-row="3"],
  .block-cell.on[data-row="6"] { --row-delay: 40ms; }
  .block-cell.on[data-row="2"],
  .block-cell.on[data-row="7"] { --row-delay: 80ms; }
  .block-cell.on[data-row="1"],
  .block-cell.on[data-row="8"] { --row-delay: 120ms; }
  .block-cell.on[data-row="0"],
  .block-cell.on[data-row="9"] { --row-delay: 160ms; }

  @keyframes blockMaterialize {
    0% {
      background: #ffffff;
      border-color: rgba(200,255,0,0.6);
      box-shadow: 0 0 12px rgba(200,255,0,0.8), inset 0 0 4px rgba(255,255,255,0.5);
      opacity: 0.3;
    }
    30% {
      background: #e0ff66;
      opacity: 1;
      box-shadow: 0 0 8px rgba(200,255,0,0.4), inset -1.5px -1.5px 0 rgba(0,0,0,0.1), inset 1.5px 1.5px 0 rgba(255,255,255,0.15);
    }
    100% {
      background: var(--phosphor);
      border-color: rgba(0,0,0,0.3);
      box-shadow: inset -1.5px -1.5px 0 rgba(0,0,0,0.2), inset 1.5px 1.5px 0 rgba(255,255,255,0.08);
      opacity: 1;
    }
  }

  /* Scanline sweep */
  .crt-scanline {
    position: absolute;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(180deg, transparent, rgba(200,255,0,0.6), transparent);
    top: 50%;
    opacity: 0;
    pointer-events: none;
    animation: scanSweep 0.6s ease-out 0.5s both;
  }

  @keyframes scanSweep {
    0% {
      top: 50%;
      opacity: 0.8;
      height: 3px;
    }
    20% {
      opacity: 1;
      height: 4px;
    }
    50% {
      top: 0%;
      opacity: 0.5;
    }
    100% {
      top: -10%;
      opacity: 0;
    }
  }

  /* ── BREATHING ANIMATION (after boot) — speed via --breath-speed ── */
  @keyframes logoBreath {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.85; }
  }

  .block-logo.breathing .block-letter {
    animation: logoBreath var(--breath-speed, 4s) ease-in-out infinite;
    cursor: pointer;
  }
  .block-logo.breathing .block-letter[data-letter-index="0"] { animation-delay: 0ms; }
  .block-logo.breathing .block-letter[data-letter-index="1"] { animation-delay: 200ms; }
  .block-logo.breathing .block-letter[data-letter-index="2"] { animation-delay: 400ms; }
  .block-logo.breathing .block-letter[data-letter-index="3"] { animation-delay: 600ms; }

  /* Revenue flash — amber pulse on individual cells */
  @keyframes revenueFlash {
    0% { background: var(--amber, #ffb000); box-shadow: 0 0 8px rgba(255,176,0,0.6); }
    100% { background: var(--phosphor, #c8ff00); box-shadow: none; }
  }
  .block-cell.revenue-flash {
    animation: revenueFlash 0.5s ease-out;
  }

  /* ── HOVER SCATTER (desktop only) ── */
  @media (hover: hover) {
    .block-cell.on {
      transition: transform 0.4s ease-in;
    }
    .block-logo:hover .block-cell.on {
      transition: transform 0.3s ease-out;
    }
  }

  /* ── AGENT OFFLINE DIM ── */
  .block-letter.agent-offline .block-cell.on {
    opacity: 0.6;
  }

  @media (max-width: 640px) {
    .block-logo {
      gap: 4px;
      --block-size: 7px;
      --block-gap: 1px;
    }
  }

  @media (min-width: 641px) and (max-width: 900px) {
    .block-logo {
      --block-size: 8px;
      --block-gap: 1px;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .crt-boot {
      animation: none;
    }
    .block-cell.on {
      animation: none;
      opacity: 1;
      transition: none !important;
    }
    .crt-scanline {
      display: none;
    }
    .block-logo.breathing .block-letter {
      animation: none;
    }
  }
</style>

<script>
  (function() {
    const REDUCED = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (REDUCED) return;

    const logo = document.querySelector('.block-logo');
    if (!logo) return;

    // ── 1a. Start breathing after boot completes ──
    setTimeout(() => {
      logo.classList.add('breathing');
    }, 2000);

    // ── 1b. Agent status mapping + data heartbeat ──
    let lastRevenue = 0;
    function checkAgentStatus() {
      fetch('/svc/status.json')
        .then(r => r.json())
        .then(data => {
          const agents = data?.agents || {};
          document.querySelectorAll('.block-letter[data-agents]').forEach(el => {
            const mapped = (el.getAttribute('data-agents') || '').split(',');
            let maxIntensity = 0;
            let anyOffline = false;

            mapped.forEach(a => {
              const info = agents[a];
              if (!info) return;
              if (info.status && info.status !== 'online' && info.status !== 'ONLINE') {
                anyOffline = true;
                return;
              }
              // Map activity recency to breathing speed
              const lastActive = info.lastActive || info.last_active;
              if (lastActive) {
                const mins = (Date.now() - new Date(lastActive).getTime()) / 60000;
                if (mins < 5) maxIntensity = Math.max(maxIntensity, 3);
                else if (mins < 30) maxIntensity = Math.max(maxIntensity, 2);
                else if (mins < 120) maxIntensity = Math.max(maxIntensity, 1);
              }
            });

            el.classList.toggle('agent-offline', anyOffline);
            // Set breathing speed based on agent activity
            const speeds = ['6s', '4s', '2.5s', '1.5s'];
            (el as HTMLElement).style.setProperty('--breath-speed', speeds[maxIntensity]);
          });

          // Revenue glow — flash random cells when revenue changes
          const rev = data?.revenue?.total_earned || data?.metrics?.revenue;
          if (rev && lastRevenue && rev > lastRevenue) {
            const cells = logo.querySelectorAll('.block-cell.on');
            const count = Math.min(5, Math.floor((rev - lastRevenue) / 100) + 1);
            for (let i = 0; i < count; i++) {
              const cell = cells[Math.floor(Math.random() * cells.length)] as HTMLElement;
              if (cell) {
                cell.classList.add('revenue-flash');
                setTimeout(() => cell.classList.remove('revenue-flash'), 600);
              }
            }
          }
          if (rev) lastRevenue = rev;
        })
        .catch(() => {});
    }
    setTimeout(checkAgentStatus, 3000);
    setInterval(checkAgentStatus, 30000);

    // ── 1c. Hover scatter (desktop only) ──
    const hasHover = window.matchMedia('(hover: hover)').matches;
    if (hasHover) {
      logo.addEventListener('mouseenter', () => {
        logo.querySelectorAll('.block-cell.on').forEach(cell => {
          const x = (Math.random() * 6 - 3).toFixed(1);
          const y = (Math.random() * 6 - 3).toFixed(1);
          (cell as HTMLElement).style.transform = `translate(${x}px, ${y}px)`;
        });
      });
      logo.addEventListener('mouseleave', () => {
        logo.querySelectorAll('.block-cell.on').forEach(cell => {
          (cell as HTMLElement).style.transform = 'translate(0,0)';
        });
      });
    }

    // ── 1d. Click to navigate ──
    const letterRoutes: Record<string, string> = {
      '0': '/agents/seraphim',
      '1': '/agents/chronicle',
      '2': '/agents/squaer',
      '3': '/agents/sentinel',
    };
    document.querySelectorAll('.block-letter[data-letter-index]').forEach(el => {
      const idx = el.getAttribute('data-letter-index') || '';
      const route = letterRoutes[idx];
      if (route) {
        (el as HTMLElement).title = el.getAttribute('data-agents')?.split(',')[0]?.toUpperCase() || '';
        el.addEventListener('click', () => { window.location.href = route; });
      }
    });

    // ── 1e. Metric flash ──
    let lastFlash = 0;
    function metricFlash() {
      const now = Date.now();
      if (now - lastFlash < 20000) return;
      const cells = logo.querySelectorAll('.block-cell.on');
      if (!cells.length) return;
      const cell = cells[Math.floor(Math.random() * cells.length)] as HTMLElement;
      lastFlash = now;
      const orig = cell.style.background;
      cell.style.background = 'var(--amber)';
      setTimeout(() => { cell.style.background = orig || ''; }, 150);
    }
    function scheduleFlash() {
      const delay = 30000 + Math.random() * 30000;
      setTimeout(() => {
        metricFlash();
        scheduleFlash();
      }, delay);
    }
    // Start after boot
    setTimeout(scheduleFlash, 3000);
  })();
</script>
