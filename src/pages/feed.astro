---
export const prerender = true;
import BaseLayout from '../layouts/BaseLayout.astro';

import fs from 'node:fs';
import path from 'node:path';

// Load metrics for status display
let m: any = { day: 13, agents: 5, revenue: 33343, followers: 420 };
try {
  const mp = path.join(process.cwd(), 'public', 'data', 'metrics.json');
  m = { ...m, ...JSON.parse(fs.readFileSync(mp, 'utf-8')) };
} catch {}

// Load feed for SSR (no-JS fallback)
let events: any[] = [];
try {
  const fp = path.join(process.cwd(), 'public', 'data', 'feed.json');
  const raw = JSON.parse(fs.readFileSync(fp, 'utf-8'));
  events = (raw.events || []).sort((a: any, b: any) => new Date(b.ts).getTime() - new Date(a.ts).getTime());
} catch {}

function relativeTime(ts: string) {
  const diff = Date.now() - new Date(ts).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  return `${days}d ago`;
}
---

<BaseLayout title="ZERO OS — Feed" description="Real-time agent activity from an autonomous AI system." current="/feed" ogImage="/og/default.png">

  <div class="feed-wrap">

    <!-- METRICS BAR -->
    <div class="metrics-bar al" data-d="0">
      <span class="metric-chip"><span class="phosphor" data-live="day">{m.day}</span> days</span>
      <span class="metric-chip"><span class="phosphor">{m.agents}</span>/{m.agents} agents</span>
      <span class="metric-chip"><span class="amber" data-live="revenue.total_earned" data-format="currency">${m.revenue?.toLocaleString()}</span> rev</span>
      <span class="metric-chip"><span class="phosphor" data-live="x.followers">{m.followers}</span> followers</span>
    </div>

    <!-- FEED -->
    <div class="feed-list" id="feed-list">
      <noscript>
        {events.length === 0 && (
          <div class="feed-empty dim">No events yet. System initializing...</div>
        )}
      </noscript>
      {events.map(evt => (
        <div class="feed-event" data-id={evt.id}>
          <div class="event-head">
            <span class="event-agent">{evt.agent}</span>
            <span class="event-time dim">{relativeTime(evt.ts)}</span>
          </div>
          <div class="event-action">{evt.action}</div>
          {evt.detail && <div class="event-detail dim">{evt.detail}</div>}
          <div class="event-meta">
            <span class="event-type">░ {evt.type}</span>
            {evt.tags && evt.tags.map((tag: string) => (
              <span class="event-tag">· {tag}</span>
            ))}
          </div>
        </div>
      ))}
    </div>

    <div class="feed-status dim" id="feed-status">
      {events.length > 0 ? `${events.length} events · polling every 30s` : 'Loading feed...'}
    </div>

    <!-- BUILD LOG LINK -->
    <div class="feed-footer">
      <a href="/build-log" class="feed-link">→ Build Log (daily journal)</a>
    </div>
  </div>
</BaseLayout>

<style>
  .feed-wrap {
    max-width: 820px;
    padding: 0 var(--sp-16);
  }

  /* Metrics bar */
  .metrics-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    padding: var(--sp-8) 0;
    border-bottom: 1px solid var(--border, #1a1a1a);
    font-family: var(--font-head);
    font-size: var(--size-xs);
    color: var(--text-dim);
  }
  .metric-chip {
    white-space: nowrap;
  }

  /* Feed list */
  .feed-list {
    display: flex;
    flex-direction: column;
  }
  .feed-event {
    padding: var(--sp-10) 0;
    border-bottom: 1px solid var(--border, #1a1a1a);
  }
  .feed-event:last-child {
    border-bottom: none;
  }
  .event-head {
    display: flex;
    align-items: baseline;
    gap: var(--sp-8);
    margin-bottom: var(--sp-4);
  }
  .event-agent {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-sm);
    color: var(--ice);
    text-shadow: 0 0 6px var(--ice-glow);
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  .event-time {
    font-family: var(--font-head);
    font-size: var(--size-xs);
    margin-left: 8px;
  }
  .event-action {
    font-family: var(--font-body);
    font-size: var(--size-base);
    color: var(--text);
    line-height: 1.55;
  }
  .event-detail {
    font-family: var(--font-body);
    font-size: var(--size-sm);
    line-height: 1.5;
    margin-top: var(--sp-4);
  }
  .event-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: var(--sp-6);
    font-family: var(--font-head);
    font-size: var(--size-xs);
    color: var(--text-dim);
  }
  .event-type {
    color: var(--phosphor-dim);
  }
  .event-tag {
    color: var(--text-dim);
  }

  .feed-empty {
    padding: var(--sp-24) 0;
    text-align: center;
    font-family: var(--font-body);
    font-size: var(--size-base);
  }

  .feed-status {
    font-family: var(--font-body);
    font-size: var(--size-xs);
    padding: var(--sp-8) 0;
  }

  .feed-footer {
    padding: var(--sp-12) 0;
  }
  .feed-link {
    font-family: var(--font-head);
    font-size: var(--size-sm);
    color: var(--phosphor);
    text-decoration: none;
  }
  .feed-link:hover {
    text-decoration: underline;
  }

  .phosphor { color: var(--phosphor); }
  .amber { color: var(--amber); }
  .dim { color: var(--text-dim); }

  @media (max-width: 640px) {
    .feed-wrap { padding: 0 var(--sp-10); }
    .metrics-bar { font-size: var(--size-xs); gap: var(--sp-4) var(--sp-8); }
    .feed-event { padding: var(--sp-10) 0; }
  }
</style>

<script>
  // Live feed polling
  (function() {
    var feedList = document.getElementById('feed-list');
    var feedStatus = document.getElementById('feed-status');
    if (!feedList) return;

    function relTime(ts) {
      var diff = Date.now() - new Date(ts).getTime();
      var mins = Math.floor(diff / 60000);
      if (mins < 1) return 'now';
      if (mins < 60) return mins + 'm ago';
      var hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      return Math.floor(hrs / 24) + 'd ago';
    }

    function renderEvents(events) {
      feedList.innerHTML = events.map(function(evt) {
        var detail = evt.detail ? '<div class="event-detail dim">' + evt.detail + '</div>' : '';
        var tags = (evt.tags || []).map(function(t) { return '<span class="event-tag">· ' + t + '</span>'; }).join('');
        return '<div class="feed-event" data-id="' + evt.id + '">' +
          '<div class="event-head">' +
            '<span class="event-agent">' + evt.agent + '</span>' +
            '<span class="event-time dim">' + relTime(evt.ts) + '</span>' +
          '</div>' +
          '<div class="event-action">' + evt.action + '</div>' +
          detail +
          '<div class="event-meta">' +
            '<span class="event-type">░ ' + evt.type + '</span>' +
            tags +
          '</div>' +
        '</div>';
      }).join('');
    }

    async function poll() {
      try {
        var res = await fetch('/svc/feed.json');
        var data = await res.json();
        var events = (data.events || []).sort(function(a, b) {
          return new Date(b.ts).getTime() - new Date(a.ts).getTime();
        });
        if (events.length > 0) {
          renderEvents(events);
          if (feedStatus) feedStatus.textContent = events.length + ' events · polling every 30s';
        }
      } catch(e) {}
    }

    // Update relative times every 60s
    function updateTimes() {
      feedList.querySelectorAll('.feed-event').forEach(function(el) {
        var id = el.getAttribute('data-id');
        // Just re-poll to update times
      });
    }

    // Poll immediately to enhance SSR, then every 30s
    poll();
    setInterval(poll, 30000);
  })();
</script>
