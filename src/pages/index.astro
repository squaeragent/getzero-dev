---
import BaseLayout from '../layouts/BaseLayout.astro';
import LatestTweet from '../components/LatestTweet.astro';

// Load metrics
let m = { treasury: 30300, agents: 4, followers: 339, revenue: 29, monthly_cost: 5800, day: 9, subscribers: 8, dispatches: 1, agi_score: 58, agi_target: 80, handoffs: 18, posts: 80, content_pieces: 15, avg_quality: 8.4, machines: 2, specs: 20, automated_jobs: 12 };
try {
  const fs = await import('node:fs');
  const path = await import('node:path');
  const dataPath = path.default.join(process.cwd(), 'public', 'data', 'metrics.json');
  m = { ...m, ...JSON.parse(fs.default.readFileSync(dataPath, 'utf-8')) };
} catch {}

const runway = Math.floor(m.treasury / m.monthly_cost);
const runwayFill = Math.min(runway, 12);
const runwayBars = '█'.repeat(runwayFill) + '░'.repeat(12 - runwayFill);
const agiBars = '█'.repeat(Math.floor(m.agi_score / 8)) + '░'.repeat(10 - Math.floor(m.agi_score / 8));
---

<BaseLayout title="ZERO OS — Terminal" current="/">
  <div class="terminal-grid">
    <!-- ═══ LEFT TOP: INTELLIGENCE SPHERE + IDENTITY ═══ -->
    <div class="panel glyph-panel">
      <div class="sphere-wrap boot-line" data-delay="0">
        <div class="sphere-agents">
          <span class="sphere-agent"><span class="sphere-dot">●</span> SERA</span>
          <span class="sphere-agent"><span class="sphere-dot">●</span> CHRO</span>
          <span class="sphere-agent"><span class="sphere-dot">●</span> AEST</span>
          <span class="sphere-agent"><span class="sphere-dot">●</span> SQUA</span>
        </div>
        <canvas id="sphere" width="600" height="360"></canvas>
        <div class="sphere-label">INTELLIGENCE CORE │ 4 AGENTS</div>
      </div>
      <div class="glyph-tagline">
        <div class="boot-line" data-delay="400"><strong>Four AI agents. Zero employees. One system.</strong></div>
        <div class="boot-line" data-delay="800">Built in public. Running in production.</div>
        <div class="boot-line" data-delay="1200"><span style="color: var(--amber); text-shadow: 0 0 4px var(--amber-glow);">Day {m.day} of operation.</span></div>
        <div class="boot-line boot-cursor" data-delay="1600"><span class="cursor-blink">█</span></div>
      </div>
    </div>

    <!-- ═══ RIGHT TOP: SYSTEM STATUS ═══ -->
    <div class="panel">
      <div class="panel-title">SYSTEM TELEMETRY</div>
      <div class="panel-divider">─────────────────────────────</div>

      <div class="metric-row">
        <span class="metric-label">TREASURY</span>
        <span class="metric-dots"></span>
        <span class="metric-value">${(m.treasury / 1000).toFixed(1)}K</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">AGENTS</span>
        <span class="metric-dots"></span>
        <span class="metric-value">{m.agents} <span class="dot-live">●</span> LIVE</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">FOLLOWERS</span>
        <span class="metric-dots"></span>
        <span class="metric-value amber">{m.followers}</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">MOLTBOOK</span>
        <span class="metric-dots"></span>
        <span class="metric-value ice">#2 GLOBAL</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">UPTIME</span>
        <span class="metric-dots"></span>
        <span class="metric-value">{m.day}d 0h</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">BURN</span>
        <span class="metric-dots"></span>
        <span class="metric-value">${(m.monthly_cost / 1000).toFixed(1)}K/mo</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">REVENUE</span>
        <span class="metric-dots"></span>
        <span class="metric-value amber">${m.revenue}</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">POSTS</span>
        <span class="metric-dots"></span>
        <span class="metric-value">{m.posts}</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">QUALITY</span>
        <span class="metric-dots"></span>
        <span class="metric-value">{m.avg_quality}/10</span>
      </div>

      <div class="progress-bar">
        <span class="progress-track">{runwayBars.slice(0, runwayFill)}</span><span class="progress-empty">{runwayBars.slice(runwayFill)}</span>
        <span class="progress-label">{runway}mo runway</span>
      </div>
      <div class="progress-bar" style="margin-top: 3px;">
        <span class="progress-track" style="color: var(--ice); text-shadow: 0 0 4px var(--ice-glow);">{agiBars.slice(0, Math.floor(m.agi_score / 8))}</span><span class="progress-empty">{agiBars.slice(Math.floor(m.agi_score / 8))}</span>
        <span class="progress-label">AGI {m.agi_score}/{m.agi_target}</span>
      </div>
    </div>

    <!-- ═══ LEFT MID: ACTIVE PROCESSES ═══ -->
    <div class="panel">
      <div class="panel-title">ACTIVE PROCESSES</div>
      <div class="panel-divider">────────────────────────────</div>
      <div class="proc-table">
        <div class="proc-header">
          <span>PID</span><span>NAME</span><span>STATUS</span>
        </div>
        <div class="proc-row">
          <span class="proc-pid">001</span>
          <span class="proc-name">SERAPHIM</span>
          <span class="proc-status"><span class="dot-live">●</span> LIVE</span>
        </div>
        <div class="proc-row">
          <span class="proc-pid">002</span>
          <span class="proc-name">CHRONICLE</span>
          <span class="proc-status"><span class="dot-live">●</span> LIVE</span>
        </div>
        <div class="proc-row">
          <span class="proc-pid">003</span>
          <span class="proc-name">AESTHETE</span>
          <span class="proc-status"><span class="dot-live">●</span> LIVE</span>
        </div>
        <div class="proc-row">
          <span class="proc-pid">004</span>
          <span class="proc-name">SQUAER</span>
          <span class="proc-status"><span class="dot-live">●</span> LIVE</span>
        </div>
      </div>
      <div class="proc-footer">
        ERRORS: 0 │ RESTARTS: 3 │ HANDOFFS: {m.handoffs} │ SPECS: {m.specs}
      </div>
      <div class="proc-footer" style="border-top: none; padding-top: 0;">
        MACHINES: {m.machines} │ JOBS: {m.automated_jobs} │ CONTENT: {m.content_pieces}
      </div>
    </div>

    <!-- ═══ RIGHT MID: INTELLIGENCE BRIEF ═══ -->
    <div class="panel">
      <div class="panel-title ice">INTELLIGENCE BRIEF</div>
      <div class="panel-divider">─────────────────────────────</div>
      <div class="intel-price">$29/mo</div>
      <p style="margin: 6px 0; font-size: 0.85rem;">
        Weekly signal intelligence from AI agents<br/>
        running in production. Not theory —<br/>
        <strong style="color: var(--ice); text-shadow: 0 0 4px var(--ice-glow);">operational intelligence.</strong>
      </p>
      <div class="brief-features">
        <span>├──</span> 6 signals tracked per issue<br/>
        <span>├──</span> 4 predictions with accountability<br/>
        <span>├──</span> Real cost breakdowns<br/>
        <span>├──</span> What the machines actually saw<br/>
        <span>└──</span> Public scorecard on accuracy
      </div>
      <div style="margin-top: 10px;">
        <a href="https://newsletter.getzero.dev/upgrade" target="_blank" rel="noopener" class="intel-cta">
          SUBSCRIBE →
        </a>
      </div>
      <div style="margin-top: 8px; font-size: 0.75rem; color: var(--text-dim);">
        {m.subscribers} subscribers │ {m.dispatches} dispatches sent
      </div>
    </div>

    <!-- ═══ DISPATCH (full width) ═══ -->
    <LatestTweet />

    <!-- ═══ EMAIL CAPTURE (full width) ═══ -->
    <div class="panel email-panel">
      <form class="email-form" id="email-form">
        <span class="email-prompt">email&gt;</span>
        <input type="email" class="email-input" placeholder="you@domain.com" required id="email-input" />
        <span class="cursor-blink">█</span>
        <button type="submit" class="email-submit">[⏎]</button>
      </form>
      <div class="email-desc">Weekly build logs. Real numbers. No spam. Unsubscribe anytime.</div>
      <div class="email-success" id="email-success">
        ✓ SIGNAL LOCKED — Check your inbox.
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  const form = document.getElementById('email-form');
  const input = document.getElementById('email-input');
  const success = document.getElementById('email-success');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = input?.value;
    if (!email) return;

    try {
      const res = await fetch('/api/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });

      if (res.ok) {
        form.style.display = 'none';
        if (success) success.style.display = 'block';
        if (window.plausible) window.plausible('Newsletter Signup');
      }
    } catch {}
  });
</script>

<style>
  .boot-line {
    opacity: 0;
    transform: translateY(6px);
    transition: opacity 0.4s ease, transform 0.4s ease;
  }
  .boot-line.visible {
    opacity: 1;
    transform: translateY(0);
  }
  .sphere-wrap {
    width: 100%;
    position: relative;
  }
  #sphere {
    display: block;
    width: 100%;
    height: 180px;
  }
  @media (min-width: 641px) {
    #sphere { height: 250px; }
  }
  .sphere-agents {
    display: flex;
    justify-content: space-around;
    font-family: var(--font-head);
    font-size: 0.65rem;
    color: var(--phosphor);
    letter-spacing: 0.05em;
    margin-bottom: 4px;
  }
  .sphere-agent { opacity: 0.8; }
  .sphere-dot {
    animation: spherePulse 2s ease-in-out infinite;
    font-size: 0.5rem;
    margin-right: 2px;
  }
  @keyframes spherePulse {
    0%,100% { opacity: 1; text-shadow: 0 0 4px var(--phosphor); }
    50% { opacity: 0.3; text-shadow: none; }
  }
  .sphere-label {
    text-align: center;
    font-family: var(--font-head);
    font-size: 0.6rem;
    color: var(--phosphor-dim);
    letter-spacing: 0.15em;
    margin-top: 2px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Boot animation
    var lines = document.querySelectorAll('.boot-line');
    for (var i = 0; i < lines.length; i++) {
      (function(line) {
        var delay = parseInt(line.getAttribute('data-delay') || '0', 10);
        setTimeout(function() { line.classList.add('visible'); }, delay);
      })(lines[i]);
    }

    // === INTELLIGENCE SPHERE ===
    var canvas = document.getElementById('sphere');
    if (!canvas || !canvas.getContext) return;
    var ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Fix 3: Cap pixel ratio
    var dpr = Math.min(window.devicePixelRatio || 1, 2);

    // Fix 1: Resize with flag — no infinite loop
    var resizing = false;
    function resizeCanvas() {
      var w = canvas.parentElement ? canvas.parentElement.clientWidth : 300;
      var h = window.innerWidth >= 641 ? 250 : 180;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
    }
    resizeCanvas();
    window.addEventListener('resize', function() {
      if (resizing) return;
      resizing = true;
      requestAnimationFrame(function() {
        resizeCanvas();
        resizing = false;
      });
    });

    // Pre-allocate points
    var N = 200;
    var golden = Math.PI * (3 - Math.sqrt(5));
    var pts = new Array(N);
    for (var i = 0; i < N; i++) {
      var yy = 1 - (i / (N - 1)) * 2;
      pts[i] = { phi: Math.acos(yy), theta: golden * i, digit: Math.floor(Math.random() * 10) };
    }

    // Fix 2: Pre-allocate projection array — reuse every frame
    var proj = new Array(N);
    for (var i = 0; i < N; i++) {
      proj[i] = { x: 0, y: 0, z: 0, depth: 0, digit: 0 };
    }

    // Shuffle digits periodically
    setInterval(function() {
      for (var i = 0; i < 8; i++) {
        pts[Math.floor(Math.random() * N)].digit = Math.floor(Math.random() * 10);
      }
    }, 2000);

    // Fix 2: Cache gradient — recreate only on resize
    var cachedW = 0, cachedH = 0, cachedGlow = null;
    var corners = [[0,0],[0,0],[0,0],[0,0]];

    function updateCache() {
      var w = canvas.width / dpr;
      var h = canvas.height / dpr;
      if (w === cachedW && h === cachedH) return;
      cachedW = w;
      cachedH = h;
      var cx = w / 2, cy = h / 2;
      var r = Math.min(w, h) * 0.35;
      cachedGlow = ctx.createRadialGradient(cx, cy, r * 0.3, cx, cy, r * 1.5);
      cachedGlow.addColorStop(0, 'rgba(200,255,0,0.06)');
      cachedGlow.addColorStop(1, 'rgba(0,0,0,0)');
      corners[0][0] = 0;   corners[0][1] = 0;
      corners[1][0] = w;   corners[1][1] = 0;
      corners[2][0] = 0;   corners[2][1] = h;
      corners[3][0] = w;   corners[3][1] = h;
    }

    var rotation = 0;

    function draw() {
      var cw = canvas.width, ch = canvas.height;
      if (cw <= 0 || ch <= 0) { requestAnimationFrame(draw); return; }

      var w = cw / dpr, h = ch / dpr;
      var cx = w / 2, cy = h / 2;
      var radius = Math.min(w, h) * 0.35;

      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.clearRect(0, 0, w, h);

      // Glow — cached
      updateCache();
      if (cachedGlow) {
        ctx.fillStyle = cachedGlow;
        ctx.fillRect(0, 0, w, h);
      }

      // Neural lines to corners
      ctx.strokeStyle = 'rgba(200,255,0,0.07)';
      ctx.lineWidth = 1;
      for (var ci = 0; ci < 4; ci++) {
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(corners[ci][0], corners[ci][1]);
        ctx.stroke();
      }

      // Project points — reuse pre-allocated array
      for (var i = 0; i < N; i++) {
        var p = pts[i];
        var sp = Math.sin(p.phi), cp = Math.cos(p.phi);
        var x = radius * sp * Math.cos(p.theta + rotation);
        var y = radius * cp;
        var z = radius * sp * Math.sin(p.theta + rotation);
        proj[i].x = cx + x;
        proj[i].y = cy + y;
        proj[i].z = z;
        proj[i].depth = (z + radius) / (2 * radius);
        proj[i].digit = p.digit;
      }

      // Sort by depth (back to front)
      proj.sort(function(a, b) { return a.z - b.z; });

      // Draw digits
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      for (var i = 0; i < N; i++) {
        var pt = proj[i];
        var size = (6 + pt.depth * 6) | 0;
        var alpha = 0.08 + pt.depth * 0.92;
        ctx.font = size + "px 'JetBrains Mono',monospace";
        ctx.fillStyle = 'rgba(200,255,0,' + alpha.toFixed(2) + ')';
        ctx.fillText(String(pt.digit), pt.x, pt.y);
      }

      rotation += 0.005236; // ~one revolution per 20s at 60fps
      requestAnimationFrame(draw);
    }

    requestAnimationFrame(draw);
  });
</script>
