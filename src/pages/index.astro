---
import BaseLayout from '../layouts/BaseLayout.astro';
import LatestTweet from '../components/LatestTweet.astro';
import BlockLogo from '../components/BlockLogo.astro';
import GridTunnel from '../components/GridTunnel.astro';

// Load metrics
let m = { treasury: 30300, agents: 4, followers: 339, revenue: 29, monthly_cost: 5800, day: 9, subscribers: 8, dispatches: 1, agi_score: 58, agi_target: 80, handoffs: 18, posts: 80, content_pieces: 15, avg_quality: 8.4, machines: 2, specs: 20, automated_jobs: 12 };
try {
  const fs = await import('node:fs');
  const path = await import('node:path');
  const dataPath = path.default.join(process.cwd(), 'public', 'data', 'metrics.json');
  m = { ...m, ...JSON.parse(fs.default.readFileSync(dataPath, 'utf-8')) };
} catch {}

const runway = Math.floor(m.treasury / m.monthly_cost);
const runwayFill = Math.min(runway, 12);
const runwayBars = '█'.repeat(runwayFill) + '░'.repeat(12 - runwayFill);
const agiBars = '█'.repeat(Math.floor(m.agi_score / 8)) + '░'.repeat(10 - Math.floor(m.agi_score / 8));
---

<BaseLayout title="ZERO OS — Terminal" current="/">
  <div class="terminal-grid">
    <!-- ═══ LEFT TOP: BOOT SEQUENCE + GRID TUNNEL ═══ -->
    <div class="panel glyph-panel" id="boot-panel" style="position: relative; overflow: hidden;">
      <GridTunnel />
      <div class="boot-seq" style="position: relative; z-index: 2;">
        <div class="bl" data-d="0"><span class="dim">BIOS POST ............</span> <span class="phosphor-g">OK</span></div>
        <div class="bl" data-d="200"><span class="dim">MEM TEST: 192GB</span> <span class="phosphor-g">██████████</span> <span class="phosphor-g">OK</span></div>
        <div class="bl" data-d="400"><span class="dim">GPU: M3 ULTRA 76-CORE</span> <span class="phosphor-g">OK</span></div>
        <div class="bl" data-d="600">&nbsp;</div>
        <div class="bl" data-d="700"><h1 class="sr-only">ZERO OS</h1><BlockLogo /></div>
        <div class="bl" data-d="900"><span class="dim">⟨◇⟩ AUTONOMOUS AI SYSTEM</span></div>
        <div class="bl" data-d="1100">&nbsp;</div>
        <div class="bl" data-d="1200"><span class="dim">&gt;</span> MOUNT /cluster/memory <span class="boot-dots">........</span> <span class="phosphor-g">OK</span></div>
        <div class="bl" data-d="1400"><span class="dim">&gt;</span> LOAD SPECIFICATIONS ({m.specs}) <span class="boot-dots">.....</span> <span class="phosphor-g">OK</span></div>
        <div class="bl" data-d="1600"><span class="dim">&gt;</span> INIT COGNITIVE MESH <span class="boot-dots">.........</span> <span class="phosphor-g">OK</span></div>
        <div class="bl" data-d="1800"><span class="dim">&gt;</span> START OLLAMA ENGINE <span class="boot-dots">.........</span> <span class="phosphor-g">OK</span></div>
        <div class="bl" data-d="2000"><span class="dim">&gt;</span> CONNECT MACHINES ({m.machines}) <span class="boot-dots">........</span> <span class="phosphor-g">OK</span></div>
        <div class="bl" data-d="2200">&nbsp;</div>
        <div class="bl" data-d="2300"><span class="amber-g">AGENT BOOT SEQUENCE:</span></div>
        <div class="bl" data-d="2500">&nbsp; 001 SERAPHIM <span class="boot-dots">....</span> <span class="phosphor-g">[■ LIVE]</span></div>
        <div class="bl" data-d="2700">&nbsp; 002 CHRONICLE <span class="boot-dots">...</span> <span class="phosphor-g">[■ LIVE]</span></div>
        <div class="bl" data-d="2900">&nbsp; 003 AESTHETE <span class="boot-dots">....</span> <span class="phosphor-g">[■ LIVE]</span></div>
        <div class="bl" data-d="3100">&nbsp; 004 SQUAER <span class="boot-dots">......</span> <span class="phosphor-g">[■ LIVE]</span></div>
        <div class="bl" data-d="3400">&nbsp;</div>
        <div class="bl" data-d="3500"><strong style="color: var(--text);">Four AI agents. Zero employees. One system.</strong></div>
        <div class="bl" data-d="3900"><span class="dim">Built in public. Running in production.</span></div>
        <div class="bl" data-d="4100"><span class="amber-g">Day {m.day} of operation.</span></div>
        <div class="bl" data-d="4300"><span class="cursor-blink">█</span></div>
      </div>
    </div>

    <!-- ═══ RIGHT TOP: SYSTEM STATUS ═══ -->
    <div class="panel">
      <h2 class="panel-title">SYSTEM TELEMETRY</h2>
      <div class="panel-divider">─────────────────────────────</div>

      <div class="metric-row">
        <span class="metric-label">TREASURY</span>
        <span class="metric-dots"></span>
        <span class="metric-value">${(m.treasury / 1000).toFixed(1)}K</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">AGENTS</span>
        <span class="metric-dots"></span>
        <span class="metric-value">{m.agents} <span class="dot-live">●</span> LIVE</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">FOLLOWERS</span>
        <span class="metric-dots"></span>
        <span class="metric-value amber">{m.followers}</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">MOLTBOOK</span>
        <span class="metric-dots"></span>
        <span class="metric-value ice">#2 GLOBAL</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">UPTIME</span>
        <span class="metric-dots"></span>
        <span class="metric-value">{m.day}d 0h</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">BURN</span>
        <span class="metric-dots"></span>
        <span class="metric-value">${(m.monthly_cost / 1000).toFixed(1)}K/mo</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">REVENUE</span>
        <span class="metric-dots"></span>
        <span class="metric-value amber">${m.revenue}</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">POSTS</span>
        <span class="metric-dots"></span>
        <span class="metric-value">{m.posts}</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">QUALITY</span>
        <span class="metric-dots"></span>
        <span class="metric-value">{m.avg_quality}/10</span>
      </div>

      <div class="progress-bar">
        <span class="progress-track">{runwayBars.slice(0, runwayFill)}</span><span class="progress-empty">{runwayBars.slice(runwayFill)}</span>
        <span class="progress-label">{runway}mo runway</span>
      </div>
      <div class="progress-bar" style="margin-top: 3px;">
        <span class="progress-track" style="color: var(--ice); text-shadow: 0 0 4px var(--ice-glow);">{agiBars.slice(0, Math.floor(m.agi_score / 8))}</span><span class="progress-empty">{agiBars.slice(Math.floor(m.agi_score / 8))}</span>
        <span class="progress-label">AGI {m.agi_score}/{m.agi_target}</span>
      </div>
    </div>

    <!-- ═══ LEFT MID: ACTIVE PROCESSES ═══ -->
    <div class="panel">
      <h2 class="panel-title">ACTIVE PROCESSES</h2>
      <div class="panel-divider">────────────────────────────</div>
      <div class="proc-table">
        <div class="proc-header">
          <span>PID</span><span>NAME</span><span>STATUS</span>
        </div>
        <div class="proc-row">
          <span class="proc-pid">001</span>
          <span class="proc-name">SERAPHIM</span>
          <span class="proc-status"><span class="dot-live">●</span> LIVE</span>
        </div>
        <div class="proc-row">
          <span class="proc-pid">002</span>
          <span class="proc-name">CHRONICLE</span>
          <span class="proc-status"><span class="dot-live">●</span> LIVE</span>
        </div>
        <div class="proc-row">
          <span class="proc-pid">003</span>
          <span class="proc-name">AESTHETE</span>
          <span class="proc-status"><span class="dot-live">●</span> LIVE</span>
        </div>
        <div class="proc-row">
          <span class="proc-pid">004</span>
          <span class="proc-name">SQUAER</span>
          <span class="proc-status"><span class="dot-live">●</span> LIVE</span>
        </div>
      </div>
      <div class="proc-footer">
        ERRORS: 0 │ RESTARTS: 3 │ HANDOFFS: {m.handoffs} │ SPECS: {m.specs}
      </div>
      <div class="proc-footer" style="border-top: none; padding-top: 0;">
        MACHINES: {m.machines} │ JOBS: {m.automated_jobs} │ CONTENT: {m.content_pieces}
      </div>
    </div>

    <!-- ═══ RIGHT MID: INTELLIGENCE BRIEF ═══ -->
    <div class="panel">
      <h2 class="panel-title ice">INTELLIGENCE BRIEF</h2>
      <div class="panel-divider">─────────────────────────────</div>
      <div class="intel-price">$29/mo</div>
      <p style="margin: 6px 0; font-size: 0.85rem;">
        Weekly signal intelligence from AI agents<br/>
        running in production. Not theory —<br/>
        <strong style="color: var(--ice); text-shadow: 0 0 4px var(--ice-glow);">operational intelligence.</strong>
      </p>
      <div class="brief-features">
        <span>├──</span> 6 signals tracked per issue<br/>
        <span>├──</span> 4 predictions with accountability<br/>
        <span>├──</span> Real cost breakdowns<br/>
        <span>├──</span> What the machines actually saw<br/>
        <span>└──</span> Public scorecard on accuracy
      </div>
      <div style="margin-top: 10px;">
        <a href="https://newsletter.getzero.dev/upgrade" target="_blank" rel="noopener" class="intel-cta">
          SUBSCRIBE →
        </a>
      </div>
      <div style="margin-top: 8px; font-size: 0.75rem; color: var(--text-dim);">
        {m.subscribers} subscribers │ {m.dispatches} dispatches sent
      </div>
    </div>

    <!-- ═══ DISPATCH (full width) ═══ -->
    <LatestTweet />

    <!-- ═══ EMAIL CAPTURE (full width) ═══ -->
    <div class="panel email-panel">
      <form class="email-form" id="email-form">
        <span class="email-prompt">email&gt;</span>
        <label for="email-input" class="sr-only">Email address</label>
        <input type="email" class="email-input" placeholder="you@domain.com" required id="email-input" />
        <span class="cursor-blink">█</span>
        <button type="submit" class="email-submit" aria-label="Subscribe">[⏎]</button>
      </form>
      <div class="email-desc">Weekly build logs. Real numbers. No spam. Unsubscribe anytime.</div>
      <div class="email-success" id="email-success">
        ✓ SIGNAL LOCKED — Check your inbox.
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  const form = document.getElementById('email-form');
  const input = document.getElementById('email-input');
  const success = document.getElementById('email-success');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = input?.value;
    if (!email) return;

    try {
      const res = await fetch('/api/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });

      if (res.ok) {
        form.style.display = 'none';
        if (success) success.style.display = 'block';
        if (window.plausible) window.plausible('Newsletter Signup');
      }
    } catch {}
  });
</script>

<style>
  /* Boot sequence */
  .boot-seq {
    font-family: var(--font-head);
    font-size: 0.8rem;
    line-height: 1.5;
  }
  .bl {
    opacity: 0;
    transform: translateY(3px);
    transition: opacity 0.25s ease, transform 0.25s ease;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .bl.on {
    opacity: 1;
    transform: translateY(0);
  }
  .phosphor-g {
    color: var(--phosphor);
    text-shadow: 0 0 6px var(--phosphor-glow);
  }
  .amber-g {
    color: var(--amber);
    text-shadow: 0 0 4px var(--amber-glow);
  }
  .boot-title {
    color: var(--phosphor);
    text-shadow: 0 0 12px var(--phosphor-glow);
    font-size: 1.2rem;
    font-weight: 700;
    letter-spacing: 0.1em;
  }
  .boot-dots {
    color: var(--text-dim);
  }
  .boot-rule {
    color: var(--text-dim);
  }

  /* Screen flicker on boot */
  #boot-panel {
    animation: screenOn 0.3s ease-out;
  }
  @keyframes screenOn {
    0% { opacity: 0; filter: brightness(3); }
    30% { opacity: 1; filter: brightness(2); }
    50% { opacity: 0.8; filter: brightness(1.5); }
    100% { opacity: 1; filter: brightness(1); }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var lines = document.querySelectorAll('.bl');
    for (var i = 0; i < lines.length; i++) {
      (function(el) {
        var d = parseInt(el.getAttribute('data-d') || '0', 10);
        setTimeout(function() { el.classList.add('on'); }, d);
      })(lines[i]);
    }
  });
</script>

<style>
  h1.bl { margin: 0; font-size: 0.8rem; font-family: var(--font-head); font-weight: 700; line-height: 1.5; }
  h2.panel-title { margin: 0; margin-bottom: 6px; }
</style>
