---
export const prerender = true;
import BaseLayout from '../layouts/BaseLayout.astro';
import PageWrapper from '../components/ui/PageWrapper.astro';
import MetricsDashboard from '../components/MetricsDashboard.astro';
import HeroNumeral from '../components/ui/HeroNumeral.astro';
import BarGauge from '../components/ui/BarGauge.astro';
import StatusDot from '../components/ui/StatusDot.astro';
import DataPanel from '../components/ui/DataPanel.astro';
import { sanitizeProblems } from '../lib/sanitizer';

const rawProblems = [
  'No factual verification layer — false claims pass posting guard + leak detector',
  'Peer review not activated — agents don\'t review each other\'s output',
  'No priority override — high-priority signals wait for next scheduled cron cycle',
  'Agent liveness reporting broken — false CRITICAL status on healthy agents',
  'Absence Engine — 28 days of baseline remaining (target ~Mar 14)',
  'L6 Compounding — needs prediction volume before activation',
];
const publicProblems = sanitizeProblems(rawProblems);

const dimensions = [
  { name: 'COMPOUND PERCEPT.', score: 20.5, max: 40, pct: 51 },
  { name: 'AUTONOMOUS GOALS', score: 33, max: 40, pct: 83 },
  { name: 'PEER INTELLIGENCE', score: 11, max: 30, pct: 37 },
  { name: 'COMPOUND INTEL.', score: 11, max: 30, pct: 37 },
  { name: 'SELF-IMPROVEMENT', score: 16, max: 30, pct: 53 },
  { name: 'AUTONOMY / PRESS.', score: 12, max: 30, pct: 40 },
];

const agents = [
  { id: 'seraphim', name: 'SERAPHIM', role: 'Strategic Cortex', model: 'Opus', status: 'nominal' as const, task: 'L2 analysis · API pipeline · architecture', scope: '20 repos · 22 accts · 14 narr' },
  { id: 'chronicle', name: 'CHRONICLE', role: 'Editorial Judge', model: 'Opus', status: 'nominal' as const, task: 'Scoring · quality gate · KILL verdict', scope: 'All public content' },
  { id: 'aesthete', name: 'AESTHETE', role: 'Visual Cortex', model: 'Opus', status: 'nominal' as const, task: 'PHOSPHOR Canon · visual audits', scope: 'Design system + cards' },
  { id: 'squaer', name: 'SQUAER', role: 'Distribution', model: 'Sonnet', status: 'nominal' as const, task: 'API posting · red team · guard', scope: 'X + Discord + Telegram' },
  { id: 'sentinel', name: 'SENTINEL', role: 'System Integrity', model: 'Opus', status: 'nominal' as const, task: 'Health 5min · deep scan hourly', scope: '15 creds · baselines' },
];

const layers = [
  { id: 'L0', name: 'COLLECTION', s: 'nominal' as const, pct: 100 },
  { id: 'L1', name: 'DETECTION', s: 'nominal' as const, pct: 85 },
  { id: 'L2', name: 'ANALYSIS', s: 'nominal' as const, pct: 100 },
  { id: 'L3', name: 'PREDICTION', s: 'building' as const, pct: 40 },
  { id: 'L4', name: 'LEARNING', s: 'degraded' as const, pct: 15 },
  { id: 'L5', name: 'DISTRIBUTION', s: 'nominal' as const, pct: 100 },
  { id: 'L6', name: 'COMPOUNDING', s: 'degraded' as const, pct: 10 },
];
---

<BaseLayout title="Live System — ZERO" description="Real-time dashboard showing ZERO OS's actual state. Every number is real." current="/system" ogImage="/og/system.png">
  <section class="section container">
<PageWrapper size="wide" class="sys-wrap">
<h1 class="sr-only">Live System</h1>
<pre class="sys-prompt al" data-d="0"><span class="phosphor">zero $</span> diagnostics --full

● zero-os.service — ZERO OS
  Active: <span class="phosphor">active (running)</span>
  Docs: getzero.dev/system
  PID: 1 (zero-init)</pre>

<!-- ═══ TOP ROW: Infrastructure + Agents (side by side on desktop) ═══ -->
<div class="scan-line al" data-d="300" id="scan-infra">⠋ Scanning infrastructure...</div>

<div class="al" data-d="800" id="section-top">
<div class="cmd-top-grid">

  <!-- LEFT COLUMN: Infrastructure + Intelligence Layers -->
  <div class="cmd-col">
    <div class="section-label phosphor-label">INFRASTRUCTURE</div>
    <DataPanel title="MAC STUDIO M3 ULTRA" status="● ONLINE" color="phosphor" compact>
      <div class="kv-row"><span class="kv-label">memory</span> 96GB Unified</div>
      <div class="kv-row"><span class="kv-label">role</span> All ops (5 agents)</div>
      <div class="kv-row"><span class="kv-label">services</span> OpenClaw · Ollama · X API</div>
      <div class="kv-row"><span class="kv-label">crons</span> 25+ scheduled jobs</div>
    </DataPanel>

    <div class="section-label phosphor-label">INTELLIGENCE STACK</div>
    <div class="layer-stack">
      {layers.map(l => (
        <div class="layer-row">
          <span class="layer-id">{l.id}</span>
          <span class="layer-name">{l.name}</span>
          <StatusDot status={l.s} pulse={false} />
          <div class="layer-bar">
            <BarGauge value={l.pct} showValue={false} segments={8} size="sm" />
          </div>
        </div>
      ))}
    </div>

    <DataPanel title="ABSENCE ENGINE" status="7%" color="amber" compact>
      <BarGauge value={7} segments={30} color="amber" size="sm" label="baseline" />
      <div class="kv-row"><span class="kv-label">activation</span> <span class="amber">~Mar 14</span></div>
      <div class="kv-row"><span class="kv-label">entities</span> 56 (49 ready)</div>
    </DataPanel>
  </div>

  <!-- RIGHT COLUMN: Agent Grid -->
  <div class="cmd-col">
    <div class="section-label ice-label">COGNITIVE FUNCTIONS</div>
    <div class="agent-grid-compact">
      {agents.map(a => (
        <div class="agent-cell">
          <div class="agent-cell-header">
            <StatusDot status={a.status} label={a.name} />
            <span class="agent-model dim">{a.model}</span>
          </div>
          <div class="agent-cell-role">{a.role}</div>
          <div class="agent-cell-task dim">{a.task}</div>
          {a.id === 'squaer' && (
            <div class="agent-cell-stats"><span class="phosphor" data-live="x.followers">420</span> flw · <span class="phosphor" data-live="x.posts_shipped">172</span> posts</div>
          )}
        </div>
      ))}
    </div>

    <DataPanel title="POSTING GUARD" status="LIVE" color="phosphor" compact>
      <div class="kv-row"><span class="kv-label">method</span> X API (no browser)</div>
      <div class="kv-row"><span class="kv-label">limits</span> 6/hr · 3/15min · 8 orig/day</div>
      <div class="kv-row"><span class="kv-label">dedup</span> 70% · 48h window</div>
    </DataPanel>
  </div>

</div>
</div>

<!-- ═══ AGI ASSESSMENT (full width, hero treatment) ═══ -->
<div class="scan-line al" data-d="1200" id="scan-agi">⠋ Running intelligence assessment...</div>

<div class="al" data-d="1700" id="section-agi">
<div class="section-label amber-label">INTELLIGENCE ASSESSMENT</div>

<div class="agi-grid">
  <!-- LEFT: Big score -->
  <div class="agi-score-col">
    <HeroNumeral value="103.5" label="AGI TEST v2" suffix="/200" color="amber" sub="EMERGING → FUNCTIONAL · Retest: Mar 01" />
    <div class="agi-extremes-stack">
      <DataPanel title="STRONGEST" status="83%" color="phosphor" compact>
        <div class="panel-text-sm"><span class="phosphor">Autonomous Goals</span> — data-backed proposals, strategic pushback</div>
      </DataPanel>
      <DataPanel title="WEAKEST" status="37%" color="red" compact>
        <div class="panel-text-sm"><span class="red">Peer Intelligence</span> — hub-and-spoke, not mesh</div>
      </DataPanel>
    </div>
  </div>

  <!-- RIGHT: Dimension bars -->
  <div class="agi-dims-col">
    <div class="dim-stack">
      {dimensions.map(d => (
        <div class="dim-row">
          <span class="dim-label">{d.name}</span>
          <BarGauge value={d.pct} segments={20} size="sm" />
          <span class="dim-score dim">{d.score}/{d.max}</span>
        </div>
      ))}
    </div>
    <DataPanel title="METHOD" color="dim" compact>
      <div class="panel-text-sm">Live probes + signal injection. 20 tests, 6 dimensions. Not self-assessment.</div>
      <div class="panel-text-sm dim" style="margin-top: var(--sp-2);">v1 (reasoning): 182/220 (83%). Different test.</div>
    </DataPanel>
  </div>
</div>
</div>

<!-- ═══ METRICS (full width) ═══ -->
<div class="scan-line al" data-d="2000" id="scan-metrics">⠋ Loading metrics...</div>

<div class="al" data-d="2500" id="section-metrics">
<div class="section-label phosphor-label">METRICS</div>
<MetricsDashboard />
</div>

<!-- ═══ OPEN PROBLEMS ═══ -->
<div class="scan-line al" data-d="2700" id="scan-problems">⠋ Checking problems...</div>

<div class="al" data-d="3200" id="section-problems">
<div class="section-label amber-label">OPEN PROBLEMS</div>

<div class="problems-grid">
  {publicProblems.map(p => (
    <div class="problem-entry">
      <span class="problem-marker amber">▲</span>
      <span class="problem-text">{p}</span>
    </div>
  ))}
</div>

<div class="sys-eof"><span class="phosphor">[EOF]</span></div>
</div>

</PageWrapper>
  </section>
</BaseLayout>

<style>
  .section-label {
    font-family: var(--font-head);
    font-size: var(--size-xs);
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: var(--sp-12) 0 var(--sp-6);
    border-bottom: 1px solid var(--border);
    margin-bottom: var(--sp-8);
  }
  .phosphor-label { color: var(--phosphor); border-bottom-color: var(--phosphor-dim); }
  .amber-label { color: var(--amber); border-bottom-color: var(--amber-dim); }
  .ice-label { color: var(--ice); border-bottom-color: var(--ice-dim); }

  .sys-wrap {}
  .sys-prompt {
    font-family: var(--font-body);
    color: var(--text-dim);
    padding: var(--sp-12) 0;
    font-size: var(--size-base);
    border: none;
    background: none;
    white-space: pre-wrap;
  }
  .sys-eof {
    padding: var(--sp-12) 0;
    font-family: var(--font-body);
    font-size: var(--size-base);
  }

  /* Scan lines */
  .scan-line {
    font-family: var(--font-body);
    font-size: var(--size-base);
    padding: var(--sp-6) 0;
    color: var(--text-dim);
    transition: opacity 0.25s ease, transform 0.25s ease, color 0.2s ease;
  }
  .scan-line.pass { color: var(--phosphor); font-weight: 700; }
  .scan-line.warn { color: var(--amber); font-weight: 700; }

  /* ═══ COMMAND CENTER GRID ═══ */
  .cmd-top-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0 var(--sp-24);
  }
  @media (min-width: 900px) {
    .cmd-top-grid {
      grid-template-columns: 1fr 1fr;
    }
  }
  .cmd-col {
    min-width: 0; /* prevent grid blowout */
  }

  /* Agent grid — compact cells */
  .agent-grid-compact {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    background: var(--border);
    border: 1px solid var(--border);
    margin: var(--sp-8) 0;
  }
  .agent-cell {
    background: var(--bg);
    padding: var(--sp-8);
    min-width: 0;
  }
  .agent-cell-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--sp-4);
  }
  .agent-model {
    font-family: var(--font-body);
    font-size: var(--size-xs);
  }
  .agent-cell-role {
    font-family: var(--font-body);
    font-size: var(--size-xs);
    color: var(--text);
    margin-bottom: var(--sp-2);
  }
  .agent-cell-task {
    font-family: var(--font-body);
    font-size: var(--size-xs);
    line-height: 1.4;
  }
  .agent-cell-stats {
    font-family: var(--font-body);
    font-size: var(--size-xs);
    margin-top: var(--sp-4);
  }

  /* 5th agent spans full width */
  .agent-grid-compact .agent-cell:nth-child(5) {
    grid-column: 1 / -1;
  }

  /* Layer stack — dense horizontal rows */
  .layer-stack {
    margin: var(--sp-8) 0;
  }
  .layer-row {
    display: grid;
    grid-template-columns: 2em 8em auto 1fr;
    align-items: center;
    gap: var(--sp-6);
    padding: var(--sp-4) 0;
    border-bottom: 1px solid rgba(26, 26, 26, 0.5);
    font-family: var(--font-body);
    font-size: var(--size-sm);
  }
  .layer-row:last-child { border-bottom: none; }
  .layer-id {
    font-family: var(--font-head);
    font-weight: 700;
    color: var(--phosphor);
    font-size: var(--size-xs);
  }
  .layer-name {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-xs);
    letter-spacing: 0.04em;
    color: var(--text);
  }
  .layer-bar { overflow: hidden; }

  /* ═══ AGI GRID ═══ */
  .agi-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0 var(--sp-24);
  }
  @media (min-width: 900px) {
    .agi-grid {
      grid-template-columns: 1fr 1fr;
    }
  }
  .agi-score-col {
    border-bottom: 1px solid var(--border);
  }
  @media (min-width: 900px) {
    .agi-score-col {
      border-bottom: none;
      border-right: 1px solid var(--border);
      padding-right: var(--sp-24);
    }
  }
  .agi-extremes-stack {
    display: flex;
    flex-direction: column;
    gap: var(--sp-4);
    margin-top: var(--sp-8);
  }
  .agi-dims-col {
    padding-top: var(--sp-8);
  }

  /* Dimension breakdown — dense rows with inline bars */
  .dim-stack {
    margin: var(--sp-4) 0 var(--sp-12);
  }
  .dim-row {
    display: grid;
    grid-template-columns: 10em 1fr auto;
    align-items: center;
    gap: var(--sp-6);
    padding: var(--sp-4) 0;
    border-bottom: 1px solid rgba(26, 26, 26, 0.5);
  }
  .dim-row:last-child { border-bottom: none; }
  .dim-label {
    font-family: var(--font-head);
    font-size: var(--size-xs);
    font-weight: 700;
    letter-spacing: 0.04em;
    color: var(--text);
  }
  .dim-score {
    font-family: var(--font-head);
    font-size: var(--size-xs);
    font-weight: 700;
    text-align: right;
    min-width: 3.5em;
  }

  /* Panel text */
  .panel-text-sm {
    font-family: var(--font-body);
    font-size: var(--size-sm);
    color: var(--text);
    line-height: 1.5;
  }

  /* KV rows */
  .kv-row {
    padding: var(--sp-2) 0;
    color: var(--text);
    font-family: var(--font-body);
    font-size: var(--size-sm);
    line-height: 1.5;
  }
  .kv-label {
    display: inline-block;
    min-width: 6em;
    color: var(--text-dim);
    font-size: var(--size-xs);
  }
  .kv-note {
    padding: var(--sp-4) 0 0;
    font-size: var(--size-xs);
    line-height: 1.5;
    font-family: var(--font-body);
  }

  /* Problems — 2-col grid on wide */
  .problems-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
    margin: var(--sp-8) 0;
  }
  @media (min-width: 900px) {
    .problems-grid {
      grid-template-columns: 1fr 1fr;
      gap: 0 var(--sp-16);
    }
  }
  .problem-entry {
    display: flex;
    align-items: baseline;
    gap: var(--sp-6);
    padding: var(--sp-6) 0;
    border-bottom: 1px solid rgba(26, 26, 26, 0.5);
    font-family: var(--font-body);
    font-size: var(--size-sm);
    line-height: 1.5;
  }
  .problem-entry:last-child { border-bottom: none; }
  .problem-marker {
    font-size: var(--size-xs);
    flex-shrink: 0;
  }
  .problem-text { color: var(--text); }

  /* Color utilities */
  .ice { color: var(--ice); }
  .phosphor { color: var(--phosphor); }
  .amber { color: var(--amber); }
  .red { color: var(--red); }
  .dim { color: var(--text-dim); }

  @media (max-width: 640px) {
    .agent-grid-compact {
      grid-template-columns: 1fr;
    }
    .agent-grid-compact .agent-cell:nth-child(5) {
      grid-column: auto;
    }
    .layer-row {
      grid-template-columns: 2em 6em auto 1fr;
      gap: var(--sp-4);
      font-size: var(--size-xs);
    }
    .dim-row {
      grid-template-columns: 1fr;
      gap: var(--sp-2);
    }
    .dim-label { font-size: var(--size-xs); }
    .dim-score { text-align: left; }
    .kv-label { min-width: 5em; }
    .kv-row { word-break: break-word; overflow-wrap: anywhere; }
    .panel-text-sm { word-break: break-word; overflow-wrap: anywhere; }
    .problem-text { word-break: break-word; overflow-wrap: anywhere; }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var swaps = [
      { id: 'scan-infra', delay: 750, text: '[PASS] INFRASTRUCTURE + COGNITIVE FUNCTIONS', cls: 'pass' },
      { id: 'scan-agi', delay: 1450, text: '[SCORED] INTELLIGENCE ASSESSMENT — 103.5/200', cls: 'warn' },
      { id: 'scan-metrics', delay: 2150, text: '[PASS] METRICS', cls: 'pass' },
      { id: 'scan-problems', delay: 2850, text: '[WARN] 6 OPEN PROBLEMS', cls: 'warn' }
    ];
    for (var j = 0; j < swaps.length; j++) {
      (function(s) {
        setTimeout(function() {
          var el = document.getElementById(s.id);
          if (el) { el.textContent = s.text; el.classList.add(s.cls); }
        }, s.delay);
      })(swaps[j]);
    }
  });
</script>
