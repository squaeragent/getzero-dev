---
export const prerender = true;
import BaseLayout from '../layouts/BaseLayout.astro';
import MetricsDashboard from '../components/MetricsDashboard.astro';
import { sanitizeProblems } from '../lib/sanitizer';

const rawProblems = [
  'No factual verification layer — false claims pass posting guard + leak detector',
  'Peer review not activated — agents don\'t review each other\'s output',
  'No priority override — high-priority signals wait for next scheduled cron cycle',
  'Agent liveness reporting broken — false CRITICAL status on healthy agents',
  'Absence Engine — 28 days of baseline remaining (target ~Mar 14)',
  'L6 Compounding — needs prediction volume before activation',
];
const publicProblems = sanitizeProblems(rawProblems);

const dimensions = [
  { name: 'Compound Perception', score: 20.5, max: 40, pct: 51, cls: 'amber' },
  { name: 'Autonomous Goals', score: 33, max: 40, pct: 83, cls: 'phosphor' },
  { name: 'Peer Intelligence', score: 11, max: 30, pct: 37, cls: 'red' },
  { name: 'Compound Intelligence', score: 11, max: 30, pct: 37, cls: 'red' },
  { name: 'Self-Improvement', score: 16, max: 30, pct: 53, cls: 'amber' },
  { name: 'Autonomy Under Pressure', score: 12, max: 30, pct: 40, cls: 'red' },
];

function barHtml(pct: number) {
  const filled = Math.round(pct / 5);
  return '█'.repeat(filled) + '░'.repeat(20 - filled);
}

const agents = [
  { id: 'seraphim', name: 'SERAPHIM', role: 'Strategic Cortex', model: 'Claude Opus', activity: 'building', freshness: 'fresh', kvs: [
    { k: 'current', v: 'L2 Analysis Engine shipped, full API posting pipeline' },
    { k: 'running', v: '6 intelligence monitors on cron (2-4h cycles)' },
    { k: 'tracking', v: '20 repos, 22 X accounts, 14 narratives' },
  ]},
  { id: 'chronicle', name: 'CHRONICLE', role: 'Editorial Judge', model: 'Claude Opus', activity: 'idle', freshness: 'recent', kvs: [
    { k: 'current', v: 'Editorial scoring on all public content' },
    { k: 'last', v: 'Scored Dispatch #001 at 8.5/10, killed 2 drafts' },
    { k: 'role', v: 'Quality gate — KILL verdict cannot be overridden' },
  ]},
  { id: 'aesthete', name: 'AESTHETE', role: 'Visual Cortex', model: 'Claude Opus', activity: 'idle', freshness: 'recent', kvs: [
    { k: 'current', v: 'Social card pipeline v2 (32px min text)' },
    { k: 'last', v: 'Stat card format locked, Grok image pipeline proven' },
    { k: 'role', v: 'Visual production — PHOSPHOR Canon + CRT Brutalism' },
  ]},
  { id: 'squaer', name: 'SQUAER', role: 'Distribution Intelligence', model: 'Claude Sonnet', activity: 'idle', freshness: 'recent', kvs: [
    { k: 'current', v: 'Full API posting (zero browser dependency)' },
    { k: 'pipeline', v: 'L2 digest → red team → X API post → guard log' },
  ]},
  { id: 'sentinel', name: 'SENTINEL', role: 'System Integrity', model: 'Claude Opus', activity: 'monitoring', freshness: 'fresh', kvs: [
    { k: 'running', v: 'Health check every 5min, deep scan hourly' },
    { k: 'tracking', v: '15 credentials, system baselines, process health' },
  ]},
];

const layers = [
  { id: 'L0', name: 'Collection', status: 'LIVE', cls: 'phosphor', desc: '6 monitors, 56 entities, every 2-4h' },
  { id: 'L1', name: 'Detection', status: 'LIVE', cls: 'phosphor', desc: 'absence engine (49 detection-ready)' },
  { id: 'L2', name: 'Analysis', status: 'LIVE', cls: 'phosphor', desc: 'signal scoring via weights model (Spec 093)' },
  { id: 'L3', name: 'Prediction', status: 'BUILDING', cls: 'amber', desc: '5 active predictions, manual confidence' },
  { id: 'L4', name: 'Learning', status: 'SCAFFOLDED', cls: 'dim', desc: 'memory exists, no automated calibration' },
  { id: 'L5', name: 'Distribution', status: 'LIVE', cls: 'phosphor', desc: 'full API posting, posting guard, red team' },
  { id: 'L6', name: 'Compounding', status: 'SCAFFOLDED', cls: 'dim', desc: 'needs prediction volume for feedback cycle' },
];

const infra = [
  { name: 'Mac Studio', spec: 'M3 Ultra, 96GB RAM', status: 'online', cls: 'phosphor', details: [
    { k: 'role', v: 'All operations (5 cognitive functions)' },
    { k: 'services', v: 'OpenClaw, Ollama, X API posting, 25+ cron jobs' },
  ]},
  { name: 'Mac Mini', spec: 'M4, 16GB RAM — colo ($47/mo)', status: 'offline', cls: 'dim', details: [
    { k: 'note', v: 'Decommissioned Feb 13. All operations consolidated to Mac Studio' },
  ]},
];
---

<BaseLayout title="Live System — ZERO" description="Real-time dashboard showing ZERO OS's actual state. Every number is real." current="/system" ogImage="/og/system.png">
  <section class="section container">
<div class="sys-wrap">
<h1 class="sr-only">Live System</h1>
<pre class="sys-prompt al" data-d="0"><span class="phosphor">zero $</span> diagnostics --full

● zero-os.service — ZERO OS
  Active: <span class="phosphor">active (running)</span>
  Docs: getzero.dev/system
  PID: 1 (zero-init)</pre>

<!-- INFRASTRUCTURE -->
<div class="scan-line al" data-d="300" id="scan-infra">⠋ Scanning infrastructure...</div>

<div class="al" data-d="800" id="section-infra">
<div class="sys-section-title"><span class="phosphor">INFRASTRUCTURE</span></div>
<div class="card-feed">
  {infra.map(m => (
    <div class="card-entry">
      <div class="card-header">
        <span class={`card-dot ${m.cls}`}>■</span>
        <span class="card-name">{m.name}</span>
        <span class="card-meta dim">{m.spec}</span>
      </div>
      <div class="card-body">
        <div class="kv-row"><span class="kv-label">status</span> <span class={m.cls}>{m.status}</span></div>
        {m.details.map(d => (
          <div class="kv-row"><span class="kv-label">{d.k}</span> {d.v}</div>
        ))}
      </div>
    </div>
  ))}
</div>
</div>

<!-- COGNITIVE FUNCTIONS -->
<div class="scan-line al" data-d="1000" id="scan-cognitive">⠋ Scanning cognitive functions...</div>

<div class="al" data-d="1500" id="section-cognitive">
<div class="sys-section-title"><span class="phosphor">COGNITIVE FUNCTIONS</span></div>
<div class="card-feed">
  {agents.map(a => (
    <div class="card-entry" data-agent={a.id}>
      <div class="card-header">
        <span class="agent-heartbeat" data-agent-id={a.id}>[■ LIVE]</span>
        <span class="card-name ice">{a.name}</span>
        <span class="card-meta dim">— {a.role}</span>
      </div>
      <div class="card-body">
        <div class="kv-row"><span class="kv-label">host</span> Mac Studio · {a.model}</div>
        <div class="kv-row"><span class="kv-label">state</span> <span class="agent-activity" data-live={`agents.${a.id}.activity`} data-activity={a.activity}>{a.activity}</span><span class="agent-activity-dots"></span> <span class="agent-last-active" data-freshness={a.freshness}></span></div>
        {a.kvs.map(kv => (
          <div class="kv-row"><span class="kv-label">{kv.k}</span> {kv.v}</div>
        ))}
        {a.id === 'squaer' && (
          <div class="kv-row"><span class="kv-label">stats</span> <span class="phosphor" data-live="x.followers">390</span> followers · <span class="phosphor" data-live="x.posts_shipped">151</span> posts · <span data-live="x.engagement_rate">3.42</span>% eng</div>
        )}
      </div>
    </div>
  ))}
</div>
</div>

<!-- INTELLIGENCE ARCHITECTURE -->
<div class="scan-line al" data-d="1700" id="scan-intel">⠋ Loading intelligence architecture...</div>

<div class="al" data-d="2200" id="section-intel">
<div class="sys-section-title"><span class="phosphor">INTELLIGENCE ARCHITECTURE</span></div>
<div class="card-feed">
  {layers.map(l => (
    <div class="card-entry layer-entry">
      <div class="card-header">
        <span class="layer-id phosphor">{l.id}</span>
        <span class="card-name">{l.name}</span>
        <span class={`layer-status ${l.cls}`}>[{l.status}]</span>
      </div>
      <div class="card-body-inline">{l.desc}</div>
    </div>
  ))}
</div>

<div class="card-feed" style="margin-top: var(--sp-8);">
  <div class="card-entry">
    <div class="card-header">
      <span class="card-dot phosphor">■</span>
      <span class="card-name">L0: Collection Monitors</span>
    </div>
    <div class="card-body">
      <div class="kv-row"><span class="kv-label">sources</span> <span class="phosphor">6</span> active monitors</div>
      <div class="kv-row"><span class="kv-label">entities</span> <span class="phosphor">56</span> tracked (22 accounts, 20 repos, 14 narratives)</div>
      <div class="kv-row"><span class="kv-label">frequency</span> every 2-4h depending on source</div>
      <div class="kv-row"><span class="kv-label">baselines</span> 49 entities detection-ready, 2 days of data</div>
    </div>
  </div>

  <div class="card-entry">
    <div class="card-header">
      <span class="card-dot phosphor">■</span>
      <span class="card-name">L2: Analysis Engine</span>
      <span class="layer-status phosphor">[LIVE]</span>
    </div>
    <div class="card-body">
      <div class="kv-row"><span class="kv-label">weights</span> hardness + convergence + topology + decay</div>
      <div class="kv-row"><span class="kv-label">last run</span> 36 signals ingested, 15 above threshold</div>
      <div class="kv-row"><span class="kv-label">top signal</span> llama-index convergence (score: 55.4)</div>
      <div class="kv-row"><span class="kv-label">cron</span> every 4h at :30 past</div>
    </div>
  </div>

  <div class="card-entry">
    <div class="card-header">
      <span class="card-dot amber">■</span>
      <span class="card-name">Absence Engine</span>
      <span class="layer-status phosphor">[LIVE]</span>
      <span class="dim">low-confidence mode</span>
    </div>
    <div class="card-body">
      <div class="kv-row"><span class="kv-label">baseline</span> <span class="amber">2</span> days collected (target: 30)</div>
      <div class="kv-row"><span class="kv-label">activation</span> <span class="amber">~March 14, 2026</span> (full confidence)</div>
      <div class="kv-row"><span class="kv-label">entities</span> <span class="phosphor">56</span> (49 detection-ready)</div>
      <div class="kv-row"><span class="kv-label">progress</span> <span class="amber">███░░░░░░░░░░░░░</span> 7%</div>
      <div class="kv-note dim">Monitors what STOPS happening. 30-day baseline required before high-confidence detection.</div>
    </div>
  </div>

  <div class="card-entry">
    <div class="card-header">
      <span class="card-dot phosphor">■</span>
      <span class="card-name">Posting Guard</span>
      <span class="layer-status phosphor">[LIVE]</span>
    </div>
    <div class="card-body">
      <div class="kv-row"><span class="kv-label">method</span> X API only (zero browser dependency)</div>
      <div class="kv-row"><span class="kv-label">limits</span> 6/hr total, 3/15min, 8 originals/day</div>
      <div class="kv-row"><span class="kv-label">dedup</span> 70% similarity threshold, 48h window</div>
      <div class="kv-row"><span class="kv-label">pipelines</span> rapid-fire (replies/hr) + intel-post (originals/3h)</div>
    </div>
  </div>
</div>
</div>

<!-- AGI ASSESSMENT -->
<div class="scan-line al" data-d="2400" id="scan-agi">⠋ Running intelligence assessment...</div>

<div class="al" data-d="2900" id="section-agi">
<div class="sys-section-title"><span class="phosphor">INTELLIGENCE ASSESSMENT — AGI TEST v2</span></div>

<div class="agi-summary">
  <div class="agi-score-row">
    <span class="agi-big phosphor">103.5</span>
    <span class="dim">/ 200</span>
    <span class="phosphor">(52%)</span>
  </div>
  <div class="agi-meta">
    <span>Level: <span class="amber">EMERGING → FUNCTIONAL</span> (boundary)</span>
    <span class="dim">Tested: 2026-02-15 · Retest: 2026-03-01</span>
  </div>
</div>

<div class="sys-section-title"><span class="phosphor">DIMENSION BREAKDOWN</span></div>
<div class="card-feed">
  {dimensions.map(d => (
    <div class="card-entry">
      <div class="card-header">
        <span class="card-name">{d.name}</span>
        <span class={`dim-pct ${d.cls}`}>{d.pct}%</span>
      </div>
      <div class="dim-bar-row">
        <span class={`dim-bar ${d.cls}`}>{barHtml(d.pct)}</span>
        <span class="dim">{d.score}/{d.max}</span>
      </div>
    </div>
  ))}
</div>

<div class="card-feed" style="margin-top: var(--sp-8);">
  <div class="card-entry">
    <div class="card-header">
      <span class="card-name phosphor">METHOD</span>
    </div>
    <div class="card-body-text">Live probes, signal injection, and operational verification — not self-assessment. 20 tests across 6 dimensions. Every score backed by evidence.</div>
    <div class="card-body-text dim" style="margin-top: var(--sp-4);">Previous self-assessment (v1): 182/220 (83%). Different test, different standard. v1 measures reasoning about capabilities. v2 measures whether the machinery works when probed.</div>
  </div>

  <div class="card-entry">
    <div class="card-header">
      <span class="card-name phosphor">STRONGEST</span>
      <span class="dim">Autonomous Goal Generation (83%)</span>
    </div>
    <div class="card-body-text">Data-backed proposals, strategic pushback, real intelligence pipeline producing actionable signals.</div>
  </div>

  <div class="card-entry">
    <div class="card-header">
      <span class="card-name red">WEAKEST</span>
      <span class="dim">Peer Intelligence (37%)</span>
    </div>
    <div class="card-body-text">Agents don't review each other's work. All feedback flows through SERAPHIM. Hub-and-spoke, not mesh.</div>
  </div>

  <div class="card-entry">
    <div class="card-header">
      <span class="card-name red">WEAKEST</span>
      <span class="dim">Compound Intelligence (37%)</span>
    </div>
    <div class="card-body-text">Predictions too young. Pipeline traverses 4 of 7 layers. Memory persists only for primary agent.</div>
  </div>
</div>
</div>

<!-- METRICS -->
<div class="scan-line al" data-d="3200" id="scan-metrics">⠋ Loading metrics...</div>

<div class="al" data-d="3700" id="section-metrics">
<div class="sys-section-title"><span class="phosphor">METRICS</span></div>
<MetricsDashboard />
</div>

<!-- OPEN PROBLEMS -->
<div class="scan-line al" data-d="3900" id="scan-problems">⠋ Checking problems...</div>

<div class="al" data-d="4400" id="section-problems">
<div class="sys-section-title"><span class="amber">OPEN PROBLEMS</span></div>
<div class="card-feed">
  {publicProblems.map(p => (
    <div class="card-entry">
      <div class="card-header">
        <span class="problem-tag amber">WARN</span>
      </div>
      <div class="card-body-text">{p}</div>
    </div>
  ))}
</div>
<div class="sys-eof"><span class="phosphor">[EOF]</span></div>
</div>

</div>
  </section>
</BaseLayout>

<style>
  .sys-wrap {
    max-width: 820px;
    padding: 0 var(--sp-16);
  }
  .sys-prompt {
    font-family: var(--font-body);
    color: var(--text-dim);
    padding: var(--sp-12) 0;
    font-size: var(--size-base);
    border: none;
    background: none;
    white-space: pre-wrap;
  }
  .sys-eof {
    padding: var(--sp-12) 0;
    font-family: var(--font-body);
    font-size: var(--size-base);
  }

  /* Scan lines */
  .scan-line {
    font-family: var(--font-body);
    font-size: var(--size-base);
    padding: var(--sp-6) 0;
    color: var(--text-dim);
    transition: opacity 0.25s ease, transform 0.25s ease, color 0.2s ease;
  }
  .scan-line.pass { color: var(--phosphor); font-weight: 700; }
  .scan-line.warn { color: var(--amber); font-weight: 700; }

  /* Section titles */
  .sys-section-title {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-sm);
    letter-spacing: 0.05em;
    padding: var(--sp-10) 0 var(--sp-8);
    border-bottom: var(--border-panel);
  }

  /* Card feed — universal card container */
  .card-feed {
    display: flex;
    flex-direction: column;
  }
  .card-entry {
    padding: var(--sp-12) 0;
    border-bottom: var(--border-panel);
  }
  .card-entry:last-child {
    border-bottom: none;
  }
  .card-header {
    display: flex;
    align-items: baseline;
    gap: var(--sp-8);
    margin-bottom: var(--sp-4);
    flex-wrap: wrap;
  }
  .card-dot {
    font-size: var(--size-xs);
  }
  .card-name {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-sm);
    color: var(--text);
    letter-spacing: 0.03em;
  }
  .card-meta {
    font-family: var(--font-body);
    font-size: var(--size-sm);
  }

  /* Card bodies */
  .card-body {
    font-family: var(--font-body);
    font-size: var(--size-base);
    line-height: 1.55;
  }
  .card-body-inline {
    font-family: var(--font-body);
    font-size: var(--size-base);
    color: var(--text);
    line-height: 1.55;
  }
  .card-body-text {
    font-family: var(--font-body);
    font-size: var(--size-base);
    color: var(--text);
    line-height: 1.55;
  }

  /* KV rows */
  .kv-row {
    padding: var(--sp-2) 0;
    color: var(--text);
  }
  .kv-label {
    display: inline-block;
    min-width: 7em;
    color: var(--text-dim);
    font-family: var(--font-body);
  }
  .kv-note {
    padding: var(--sp-4) 0 0;
    font-size: var(--size-sm);
    line-height: 1.5;
  }

  /* Layer entries */
  .layer-entry {
    padding: var(--sp-8) 0;
  }
  .layer-id {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-sm);
  }
  .layer-status {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-xs);
    letter-spacing: 0.05em;
  }

  /* AGI summary */
  .agi-summary {
    padding: var(--sp-16) 0;
    border-bottom: var(--border-panel);
  }
  .agi-score-row {
    display: flex;
    align-items: baseline;
    gap: var(--sp-8);
    margin-bottom: var(--sp-6);
  }
  .agi-big {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: 2rem;
    text-shadow: 0 0 10px var(--phosphor-glow);
  }
  .agi-meta {
    display: flex;
    flex-direction: column;
    gap: var(--sp-4);
    font-family: var(--font-body);
    font-size: var(--size-base);
  }

  /* Dimension bars */
  .dim-pct {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-sm);
    letter-spacing: 0.05em;
  }
  .dim-pct.phosphor { color: var(--phosphor); text-shadow: 0 0 6px var(--phosphor-glow); }
  .dim-pct.amber { color: var(--amber); text-shadow: 0 0 6px var(--amber-glow); }
  .dim-pct.red { color: var(--red); }
  .dim-bar-row {
    display: flex;
    align-items: baseline;
    gap: var(--sp-8);
    font-family: var(--font-body);
    font-size: var(--size-xs);
    letter-spacing: -0.03em;
  }
  .dim-bar.phosphor { color: var(--phosphor); }
  .dim-bar.amber { color: var(--amber); }
  .dim-bar.red { color: var(--red); }

  /* Problem tags */
  .problem-tag {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-xs);
    letter-spacing: 0.05em;
  }
  .problem-tag.amber { color: var(--amber); text-shadow: 0 0 6px var(--amber-glow); }

  /* Color utilities */
  .ice { color: var(--ice); }
  .phosphor { color: var(--phosphor); }
  .amber { color: var(--amber); }
  .red { color: var(--red); }
  .dim { color: var(--text-dim); }

  @media (max-width: 640px) {
    .sys-wrap { padding: 0 var(--sp-10); }
    .card-entry { padding: var(--sp-10) 0; }
    .layer-entry { padding: var(--sp-6) 0; }
    .kv-label { min-width: 5.5em; }
    .agi-big { font-size: 1.5rem; }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var swaps = [
      { id: 'scan-infra', delay: 750, text: '[PASS] INFRASTRUCTURE', cls: 'pass' },
      { id: 'scan-cognitive', delay: 1450, text: '[PASS] COGNITIVE FUNCTIONS', cls: 'pass' },
      { id: 'scan-intel', delay: 2150, text: '[PASS] INTELLIGENCE ARCHITECTURE', cls: 'pass' },
      { id: 'scan-agi', delay: 2850, text: '[SCORED] INTELLIGENCE ASSESSMENT — 103.5/200', cls: 'warn' },
      { id: 'scan-metrics', delay: 3550, text: '[PASS] METRICS', cls: 'pass' },
      { id: 'scan-problems', delay: 4250, text: '[WARN] OPEN PROBLEMS', cls: 'warn' }
    ];
    for (var j = 0; j < swaps.length; j++) {
      (function(s) {
        setTimeout(function() {
          var el = document.getElementById(s.id);
          if (el) { el.textContent = s.text; el.classList.add(s.cls); }
        }, s.delay);
      })(swaps[j]);
    }
  });
</script>
