---
import BaseLayout from '../layouts/BaseLayout.astro';
import MetricsDashboard from '../components/MetricsDashboard.astro';

let worldState: any = {};
try {
  const fs = await import('node:fs');
  const path = await import('node:path');
  const yaml = (await import('js-yaml')).default;
  const wsPath = path.default.join(process.env.HOME || '~', 'Cluster_Memory', '00_SYSTEM', 'world_state.yaml');
  worldState = yaml.load(fs.default.readFileSync(wsPath, 'utf-8')) || {};
} catch {}

const infrastructure = worldState.infrastructure || {};
const functions = worldState.functions || {};
const problems = worldState.problems || {};
---

<BaseLayout title="Live System — ZERO" description="Real-time dashboard showing ZERO OS's actual state. Every number is real." current="/system">
  <div class="page-header container">
    <p class="section-label reveal">Live system</p>
    <h1 class="reveal">The receipts.</h1>
    <p class="section-intro">Real data from a real system. Numbers sync from ZERO OS and animate live. Nothing is hardcoded. Nothing is approximated.</p>
  </div>

  <div class="section-divider"></div>

  <section class="section container">
    <p class="section-label reveal">Infrastructure</p>
    <h2 class="reveal">Machine Status</h2>

    <div class="arch-grid stagger" style="margin-top: clamp(32px, 5vh, 48px);">
      <div class="arch-agent reveal">
        <div class="arch-header">
          <span class="arch-dot"></span>
          <span class="arch-name">Mac Studio</span>
        </div>
        <div class="arch-role">M3 Ultra, 96GB RAM</div>
        <p class="arch-desc">
          Status: <span class="status-online">{infrastructure.mac_studio?.status || 'online'}</span><br />
          Disk: {infrastructure.mac_studio?.disk_used_pct || 2}% used<br />
          Services: OpenClaw, Ollama, HIVE
        </p>
      </div>
      <div class="arch-agent reveal">
        <div class="arch-header">
          <span class="arch-dot"></span>
          <span class="arch-name">Mac Mini</span>
        </div>
        <div class="arch-role">M4, 16GB RAM — colocated</div>
        <p class="arch-desc">
          Status: <span class="status-online">{infrastructure.mac_mini?.status || 'online'}</span><br />
          Role: {infrastructure.mac_mini?.role || 'Distribution Node'}<br />
          Services: OpenClaw, Chrome CDP
        </p>
      </div>
    </div>
  </section>

  <div class="section-divider"></div>

  <section class="section container">
    <p class="section-label reveal">Agent Status</p>
    <h2 class="reveal">Cognitive Functions</h2>

    <div class="arch-grid stagger" style="margin-top: clamp(32px, 5vh, 48px);">
      {Object.entries(functions).map(([name, data]: [string, any]) => (
        <div class="arch-agent reveal">
          <div class="arch-header">
            <span class="arch-dot"></span>
            <span class="arch-name">{name.toUpperCase()}</span>
          </div>
          <div class="arch-role">{data.role}</div>
          <p class="arch-desc">
            Model: {data.model}<br />
            Brain: {data.brain_complete ? 'Complete' : 'Incomplete'}
          </p>
        </div>
      ))}
    </div>
  </section>

  <div class="section-divider"></div>

  <section class="section container">
    <p class="section-label reveal">Metrics</p>
    <h2 class="reveal">System Dashboard</h2>
    <MetricsDashboard />
  </section>

  <div class="section-divider"></div>

  <section class="section container">
    <p class="section-label reveal">Open Problems</p>
    <h2 class="reveal">What needs fixing.</h2>
    <div class="activity-feed">
      {problems.critical?.map((p: string) => (
        <div class="activity-item reveal">
          <span class="activity-time status-offline">CRITICAL</span>
          <span class="activity-text">{p}</span>
        </div>
      ))}
      {problems.high?.map((p: string) => (
        <div class="activity-item reveal">
          <span class="activity-time status-warning">HIGH</span>
          <span class="activity-text">{p}</span>
        </div>
      ))}
      {problems.medium?.map((p: string) => (
        <div class="activity-item reveal">
          <span class="activity-time mid">MEDIUM</span>
          <span class="activity-text">{p}</span>
        </div>
      ))}
    </div>
  </section>
</BaseLayout>
