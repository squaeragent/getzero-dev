---
export const prerender = true;
import BaseLayout from '../layouts/BaseLayout.astro';
import PageWrapper from '../components/ui/PageWrapper.astro';
import BriefCTA from '../components/BriefCTA.astro';
import SectionTitle from '../components/ui/SectionTitle.astro';
import BarGauge from '../components/ui/BarGauge.astro';
import HeroNumeral from '../components/ui/HeroNumeral.astro';
import DataPanel from '../components/ui/DataPanel.astro';
import fs from 'node:fs';
import path from 'node:path';

let data: any = { predictions: [], stats: { total: 0, active: 0, scored: 0, accuracy: null, streak: 0, categories: {} } };
try {
  const dataPath = path.join(process.cwd(), 'public', 'data', 'predictions.json');
  data = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));
} catch {}

const predictions = data.predictions || [];
const stats = data.stats || {};
const categories = stats.categories || {};

const total = stats.total || 0;
const active = stats.active || 0;
const scored = stats.scored || 0;
const accuracy = stats.accuracy;
const streak = stats.streak || 0;

function statusClass(s: string) {
  if (s === 'correct') return 'phosphor';
  if (s === 'incorrect' || s === 'wrong') return 'red';
  if (s === 'expired') return 'dim';
  if (s === 'partial') return 'amber';
  return 'dim';
}

function statusLabel(s: string) {
  if (s === 'correct') return '✅ CORRECT';
  if (s === 'incorrect' || s === 'wrong') return '❌ WRONG';
  if (s === 'partial') return '⚠️ PARTIAL';
  if (s === 'expired') return '⏰ EXPIRED';
  return '⏳ OPEN';
}

function confPct(conf: number) {
  return Math.round(conf * 100);
}

function catAccuracy(cat: any) {
  const res = (cat.correct || 0) + (cat.incorrect || 0);
  if (res === 0) return 'N/A';
  return Math.round(cat.correct / res * 100) + '%';
}
---

<BaseLayout title="Prediction Tracker — ZERO" description="Public predictions from ZERO intelligence analysis. Tracked, scored, accountable." current="/predictions" ogImage="/og/predictions.png">

<PageWrapper>

<pre class="term-block al" data-d="0"><span class="phosphor">zero $</span> predictions --status</pre>

<div class="hero-stats">
  <div class="hero-stat-row">
    <HeroNumeral value={accuracy !== null ? String(accuracy) : '—'} label="ACCURACY" suffix={accuracy !== null ? '%' : ''} color={accuracy !== null && accuracy >= 60 ? 'phosphor' : 'amber'} sub={scored === 0 ? 'Tracking — first predictions logged' : `${scored} resolved of ${total} total`} />
  </div>
  <div class="stats-bar">
    <div class="stat-cell">
      <span class="stat-num phosphor">{total}</span>
      <span class="stat-label dim">total</span>
    </div>
    <div class="stat-cell">
      <span class="stat-num ice">{active}</span>
      <span class="stat-label dim">open</span>
    </div>
    <div class="stat-cell">
      <span class="stat-num amber">{scored}</span>
      <span class="stat-label dim">resolved</span>
    </div>
    <div class="stat-cell">
      <span class="stat-num">{streak}</span>
      <span class="stat-label dim">streak</span>
    </div>
  </div>
</div>

<section class="predictions-cta-top">
  <pre class="term-block cta-block"><span class="amber">▌</span> Get predictions before they're public.
<span class="amber">▌</span> Intelligence Brief — $29/mo
<span class="amber">▌</span> <a href="https://buy.stripe.com/00w14ngdU9dHc748Fa83C00" class="phosphor cta-link">→ SUBSCRIBE</a></pre>
</section>

<div class="section-label phosphor-label">{`ACTIVE PREDICTIONS (${active} open)`}</div>

<div class="pred-feed">
  {predictions.filter((p: any) => p.status === 'active').map((p: any) => (
    <DataPanel color="dim" compact>
      <div class="p-header">
        <span class="p-id phosphor">{p.id}</span>
        <span class="p-tag dim">⏳ OPEN</span>
        <span class="p-deadline dim">{p.deadline}</span>
      </div>
      <div class="p-text">{p.claim}</div>
      <div class="p-conf-row">
        <BarGauge value={confPct(p.confidence)} label="conf" segments={20} size="sm" color="phosphor" />
      </div>
      {p.category && <div class="p-cat dim">{p.category}</div>}
    </DataPanel>
  ))}
</div>

{scored > 0 && (
  <>
    <div class="section-label amber-label">{`RESOLVED (${scored} scored)`}</div>

    <div class="pred-feed">
      {predictions.filter((p: any) => p.status !== 'active').map((p: any) => (
        <DataPanel color="dim" compact>
          <div class="p-header">
            <span class={`p-id ${statusClass(p.status)}`}>{p.id}</span>
            <span class={`p-tag ${statusClass(p.status)}`}>{statusLabel(p.status)}</span>
          </div>
          <div class="p-text">{p.claim}</div>
          <div class="p-conf-row">
            <BarGauge value={confPct(p.confidence)} label="conf" segments={20} size="sm" />
          </div>
          {p.resolution && <div class="p-resolution"><span class="dim">outcome:</span> {p.resolution}</div>}
        </DataPanel>
      ))}
    </div>
  </>
)}

<div class="section-label dim-label">CATEGORY BREAKDOWN</div>

<div class="cat-grid">
  {Object.entries(categories).map(([cat, info]: [string, any]) => (
    <div class="cat-entry">
      <div class="cat-header">
        <span class="cat-name">{cat}</span>
        <span class="cat-acc phosphor">{catAccuracy(info)}</span>
      </div>
      <BarGauge value={(info as any).open / Math.max((info as any).total, 1) * 100} label="" segments={10} size="sm" color="ice" showValue={false} />
      <div class="cat-details dim">{(info as any).total} predictions · {(info as any).open} open</div>
    </div>
  ))}
</div>

<section class="predictions-methodology">
  <DataPanel title="METHODOLOGY" color="dim">
    <div class="method-text">Every prediction is derived from ZERO's L2 signal analysis pipeline. Confidence scores reflect signal convergence, source reliability, historical base rates, and timeframe specificity penalty.</div>
    <div class="method-text dim" style="margin-top: var(--sp-6);">No prediction is edited after publication. No outcomes are cherry-picked. Full resolution history logged in JSONL.</div>
  </DataPanel>
</section>

<BriefCTA />

</PageWrapper>

</BaseLayout>

<style>
  .section-label {
    font-family: var(--font-head);
    font-size: var(--size-xs);
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: var(--sp-12) 0 var(--sp-6);
    border-bottom: 1px solid var(--border);
    margin-bottom: var(--sp-8);
  }
  .phosphor-label { color: var(--phosphor); border-bottom-color: var(--phosphor-dim); }
  .amber-label { color: var(--amber); border-bottom-color: var(--amber-dim); }
  .dim-label { color: var(--text-dim); }

  .hero-stats {
    border-bottom: 1px solid var(--border);
  }
  .stats-bar {
    display: flex;
    gap: var(--sp-24);
    padding: 0 0 var(--sp-16);
  }
  .stat-cell {
    display: flex;
    flex-direction: column;
    gap: var(--sp-2);
  }
  .stat-num {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-lg);
    color: var(--text);
  }
  .stat-label {
    font-family: var(--font-head);
    font-size: var(--size-xs);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .predictions-cta-top { margin-bottom: var(--sp-16); }
  .cta-block {
    border-left: 2px solid var(--amber);
    padding-left: var(--sp-16);
  }
  .cta-link { text-decoration: none; }
  .cta-link:hover { text-decoration: underline; }

  /* Prediction entries */
  .pred-feed {
    display: flex;
    flex-direction: column;
    margin-bottom: var(--sp-16);
  }
  .p-header {
    display: flex;
    align-items: baseline;
    gap: var(--sp-10);
    margin-bottom: var(--sp-4);
    flex-wrap: wrap;
  }
  .p-id {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-sm);
    letter-spacing: 0.05em;
  }
  .p-tag {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-xs);
    letter-spacing: 0.05em;
  }
  .p-deadline {
    font-family: var(--font-body);
    font-size: var(--size-xs);
    margin-left: auto;
  }
  .p-text {
    font-family: var(--font-body);
    color: var(--text);
    font-size: var(--size-base);
    line-height: 1.55;
    margin-bottom: var(--sp-6);
  }
  .p-conf-row { margin-bottom: var(--sp-4); }
  .p-cat {
    font-family: var(--font-body);
    font-size: var(--size-xs);
    margin-top: var(--sp-2);
  }
  .p-resolution {
    font-family: var(--font-body);
    font-size: var(--size-sm);
    margin-top: var(--sp-4);
  }

  /* Category grid */
  .cat-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--sp-12);
    margin: var(--sp-12) 0 var(--sp-24);
  }
  .cat-entry {
    padding: var(--sp-8) 0;
  }
  .cat-header {
    display: flex;
    align-items: baseline;
    gap: var(--sp-10);
    margin-bottom: var(--sp-4);
  }
  .cat-name {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text);
  }
  .cat-acc {
    font-family: var(--font-body);
    font-size: var(--size-xs);
  }
  .cat-details {
    font-family: var(--font-body);
    font-size: var(--size-xs);
    margin-top: var(--sp-4);
  }

  .predictions-methodology { margin-top: var(--sp-16); }
  .method-text {
    font-family: var(--font-body);
    font-size: var(--size-base);
    color: var(--text);
    line-height: 1.55;
  }

  .phosphor { color: var(--phosphor); }
  .amber { color: var(--amber); }
  .ice { color: var(--ice); }
  .red { color: var(--red); }
  .dim { color: var(--text-dim); }

  @media (max-width: 640px) {
    .stats-bar { gap: var(--sp-16); flex-wrap: wrap; }
    .cat-grid { grid-template-columns: 1fr; }
    .p-deadline { margin-left: 0; }
  }
</style>
