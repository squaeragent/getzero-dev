---
export const prerender = true;
import BaseLayout from '../layouts/BaseLayout.astro';
import PageWrapper from '../components/ui/PageWrapper.astro';
import BriefCTA from '../components/BriefCTA.astro';
import CardFeed from '../components/ui/CardFeed.astro';
import CardEntry from '../components/ui/CardEntry.astro';
import SectionTitle from '../components/ui/SectionTitle.astro';
import fs from 'node:fs';
import path from 'node:path';

let data: any = { predictions: [], stats: { total: 0, active: 0, scored: 0, accuracy: null, streak: 0, categories: {} } };
try {
  const dataPath = path.join(process.cwd(), 'public', 'data', 'predictions.json');
  data = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));
} catch {}

const predictions = data.predictions || [];
const stats = data.stats || {};
const categories = stats.categories || {};

const total = stats.total || 0;
const active = stats.active || 0;
const scored = stats.scored || 0;
const accuracy = stats.accuracy;
const streak = stats.streak || 0;

function statusIcon(s: string) {
  if (s === 'correct') return '✅';
  if (s === 'incorrect' || s === 'wrong') return '❌';
  if (s === 'partial') return '⚠️';
  if (s === 'expired') return '⏰';
  return '⏳';
}

function statusClass(s: string) {
  if (s === 'correct') return 'phosphor';
  if (s === 'incorrect' || s === 'wrong') return 'red';
  if (s === 'expired') return 'dim';
  if (s === 'partial') return 'amber';
  return 'dim';
}

function confPct(conf: number) {
  return Math.round(conf * 100);
}

function confBarHtml(conf: number) {
  const pct = Math.round(conf * 100);
  const filled = Math.round(pct / 5);
  return '█'.repeat(filled) + '░'.repeat(20 - filled);
}

function catAccuracy(cat: any) {
  const resolved = (cat.correct || 0) + (cat.incorrect || 0);
  if (resolved === 0) return 'N/A';
  return Math.round(cat.correct / resolved * 100) + '%';
}
---

<BaseLayout title="Prediction Tracker — ZERO" description="Public predictions from ZERO intelligence analysis. Tracked, scored, accountable. Every call logged, every outcome recorded." current="/predictions" ogImage="/og/predictions.png">

<PageWrapper>

<section class="predictions-hero">
  <pre class="term-block hero-term"><span class="phosphor">zero $</span> predictions --status

<span class="phosphor">╔══════════════════════════════════════════╗
║  ZERO PREDICTION TRACKER                ║
╚══════════════════════════════════════════╝</span>

  accuracy .... <span class="phosphor">{accuracy !== null ? accuracy + '%' : 'TRACKING'}</span>
  total ...... {total}
  open ....... {active}
  resolved ... {scored}
  streak ..... {streak}

  <span class="dim">{scored === 0 ? '[ first predictions logged — tracking begins ]' : `[ ${scored} resolved — live accuracy ]`}</span>
</pre>
</section>

<section class="predictions-cta-top">
  <pre class="term-block cta-block"><span class="amber">▌</span> Get predictions before they're public.
<span class="amber">▌</span> Intelligence Brief — $29/mo
<span class="amber">▌</span> <a href="https://buy.stripe.com/00w14ngdU9dHc748Fa83C00" class="phosphor cta-link">→ SUBSCRIBE</a></pre>
</section>

<section class="predictions-section">
  <SectionTitle>ACTIVE PREDICTIONS <span class="dim">({active} open)</span></SectionTitle>

  <CardFeed>
    {predictions.filter((p: any) => p.status === 'active').map((p: any) => (
      <CardEntry>
        <div class="p-header">
          <span class="p-id phosphor">{p.id}</span>
          <span class="p-tag dim">⏳ OPEN</span>
        </div>
        <div class="p-text">{p.claim}</div>
        <div class="p-meta">
          <div class="p-conf">
            <span class="dim">confidence</span>
            <span class="conf-bar phosphor">{confBarHtml(p.confidence)}</span>
            <span class="phosphor">{confPct(p.confidence)}%</span>
          </div>
          <div class="p-details">
            <span class="dim">deadline</span> <span>{p.deadline}</span>
            <span class="dim">category</span> <span>{p.category}</span>
            {p.source && <><span class="dim">source</span> <span>{p.source}</span></>}
          </div>
        </div>
      </CardEntry>
    ))}
  </CardFeed>
</section>

{scored > 0 && (
  <section class="predictions-section">
    <SectionTitle>RESOLVED <span class="dim">({scored} scored)</span></SectionTitle>

    <CardFeed>
      {predictions.filter((p: any) => p.status !== 'active').map((p: any) => (
        <CardEntry>
          <div class="p-header">
            <span class={`p-id ${statusClass(p.status)}`}>{p.id}</span>
            <span class={`p-tag ${statusClass(p.status)}`}>{statusIcon(p.status)} {p.status.toUpperCase()}</span>
          </div>
          <div class="p-text">{p.claim}</div>
          <div class="p-meta">
            <div class="p-conf">
              <span class="dim">confidence</span>
              <span class="conf-bar">{confBarHtml(p.confidence)}</span>
              <span>{confPct(p.confidence)}%</span>
            </div>
            {p.resolution && <div class="p-resolution"><span class="dim">outcome:</span> {p.resolution}</div>}
          </div>
        </CardEntry>
      ))}
    </CardFeed>
  </section>
)}

<section class="predictions-section">
  <SectionTitle>CATEGORY BREAKDOWN</SectionTitle>

  <div class="cat-feed">
    {Object.entries(categories).map(([cat, info]: [string, any]) => (
      <div class="cat-entry">
        <div class="cat-header">
          <span class="cat-name">{cat}</span>
          <span class="cat-acc phosphor">{catAccuracy(info)}</span>
        </div>
        <div class="cat-details dim">
          {(info as any).total} predictions · {(info as any).open} open
        </div>
      </div>
    ))}
  </div>
</section>

<section class="predictions-methodology">
  <pre class="term-block"><span class="phosphor">METHODOLOGY</span>

Every prediction is derived from ZERO's L2 signal
analysis pipeline. Confidence scores reflect:

  • Signal convergence (multiple independent sources)
  • Source reliability (hard vs soft signals)  
  • Historical base rates for similar claims
  • Timeframe specificity penalty

No prediction is edited after publication.
No outcomes are cherry-picked.
<span class="dim">Full resolution history logged in JSONL.</span>
</pre>
</section>

<BriefCTA />

</PageWrapper>

</BaseLayout>

<style>
  /* wrapper handled by PageWrapper */
  .predictions-hero {
    margin-bottom: var(--sp-16);
  }
  .hero-term {
    font-size: var(--size-md);
    line-height: 1.6;
  }
  .predictions-cta-top {
    margin-bottom: var(--sp-24);
  }
  .cta-block {
    border-left: 2px solid var(--amber);
    padding-left: var(--sp-16);
  }
  .cta-link {
    text-decoration: none;
  }
  .cta-link:hover {
    text-decoration: underline;
  }

  /* Section labels */
  .section-label {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-sm);
    letter-spacing: 0.05em;
    padding: var(--sp-8) 0;
    border-bottom: var(--border-panel);
    margin-bottom: 0;
  }

  /* Prediction entries */
  .predictions-feed,
  .cat-feed {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .p-entry {
    padding: var(--sp-12) 0;
    border-bottom: var(--border-panel);
  }
  .p-header {
    display: flex;
    align-items: baseline;
    gap: var(--sp-10);
    margin-bottom: var(--sp-4);
  }
  .p-id {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-sm);
    letter-spacing: 0.05em;
  }
  .p-tag {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .p-tag.phosphor {
    color: var(--phosphor);
    text-shadow: 0 0 6px var(--phosphor-glow);
  }
  .p-tag.amber {
    color: var(--amber);
    text-shadow: 0 0 6px var(--amber-glow);
  }
  .p-tag.red {
    color: var(--red);
  }
  .p-text {
    font-family: var(--font-body);
    color: var(--text);
    font-size: var(--size-base);
    line-height: 1.55;
    margin-bottom: var(--sp-8);
  }
  .p-meta {
    font-family: var(--font-body);
    font-size: var(--size-xs);
    color: var(--text-dim);
  }
  .p-conf {
    display: flex;
    align-items: baseline;
    gap: var(--sp-8);
    margin-bottom: var(--sp-4);
  }
  .conf-bar {
    font-size: var(--size-xs);
    letter-spacing: -0.05em;
  }
  .p-details {
    display: flex;
    flex-wrap: wrap;
    gap: var(--sp-4) var(--sp-16);
  }
  .p-resolution {
    margin-top: var(--sp-4);
  }

  /* Category entries */
  .cat-entry {
    padding: var(--sp-10) 0;
    border-bottom: var(--border-panel);
  }
  .cat-entry:last-child {
    border-bottom: none;
  }
  .cat-header {
    display: flex;
    align-items: baseline;
    gap: var(--sp-10);
    margin-bottom: var(--sp-2);
  }
  .cat-name {
    font-family: var(--font-head);
    font-weight: 700;
    font-size: var(--size-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text);
  }
  .cat-acc {
    font-family: var(--font-body);
    font-size: var(--size-xs);
  }
  .cat-details {
    font-family: var(--font-body);
    font-size: var(--size-xs);
  }

  .predictions-section {
    margin-bottom: var(--sp-24);
  }
  .predictions-methodology {
    margin-top: var(--sp-24);
    opacity: 0.8;
  }

  .phosphor { color: var(--phosphor); }
  .amber { color: var(--amber); }
  .red { color: var(--red); }
  .dim { color: var(--text-dim); }

  @media (max-width: 640px) {
    /* wrapper padding via --sp-page token */
    .p-entry { padding: var(--sp-10) 0; }
    .p-details { gap: var(--sp-4) var(--sp-10); }
    .p-conf { flex-wrap: wrap; }
  }
</style>
